window.Invoices.ModelGlobalMenuItem=Backbone.Model.extend({defaults:{name:"item",hash:"item/"}});window.Invoices.CollectionGlobalMenu=Backbone.Collection.extend({model:window.Invoices.ModelGlobalMenuItem,initialize:function(){this.add([{name:"goodss",hash:"goods/"},{name:"buyers",hash:"buyers/"},{name:"invoices",hash:"invoices/"},{name:"new invoice",hash:"invoice/"},{name:"merchant",hash:"merchant/"}])}});window.Invoices.ViewGlobalMenu=Backbone.View.extend({initialize:function(opt){this.router=opt.router;this.collection=new window.Invoices.CollectionGlobalMenu},el:$("#invoicesGlobalMenu"),statsTemplate:{"globalmenu":_.template(window.Invoices.TEMPLATE["globalmenu.globalMenu"])},render:function(){this.el.html(this.statsTemplate["globalmenu"].call(this,this.collection));return this},renderItem:function(query){var q=(query||"invoice/").replace(/^([a-zA-Z0-9_]+\/).*/,"$1");$('[data-id="item"]',this.el).each(function(){$(this).removeClass("tab-item");
var $el=$('[href="#'+q+'"]',this);if($el.size()>0)$(this).addClass("tab-item")});return this}});window.Invoices.ModelBuyersGroups=Backbone.Model.extend({defaults:{gr_id:null,title:"new group"},idAttribute:"gr_id",syncArg:{"read":null,"create":"new_group_brs","update":"edit_group_brs","delete":"del_group_brs"},syncFilter:{"create":{there:["title"]},"update":{there:["gr_id","title"]},"delete":{there:["gr_id","buyers"]}},validate:function(attrs){attrs=attrs||{};if(!/^[\w\s\u0430-\u044f\u0410-\u042f\u0451\u0401]+$/i.test(attrs.title))return{attr:"title"};var model=this.collection.get("title",attrs.title);
if(model&&this.get("gr_id")!=model.get("gr_id"))return{attr:"title",arg:true}}});window.Invoices.CollectionBuyersGroups=Backbone.Collection.extend({model:window.Invoices.ModelBuyersGroups,initialize:function(){},syncArg:{"read":"data_group_brs"}});window.Invoices.ViewBuyersGroups=Backbone.View.extend({initialize:function(opt){this.router=opt.router;this.collection=new window.Invoices.CollectionBuyersGroups;this.collectionBuyers=new window.Invoices.CollectionRouters;this.collection.bind("add",this.eventAdd,this);this.collection.bind("remove",this.eventRemove,this)},eventAdd:function(model){$("#invoicesClientsTabsList #invoicesClientsNewGroup",this.el).before(this.statsTemplate["clientsItemGroup"].call(this,model.toJSON()))},eventRemove:function(model){$('#invoicesClientsTabsList > [data-id="item-'+
model.get("gr_id")+'"]',this.el).remove();this.collectionBuyers.remove(this.collectionBuyers.get(model.get("gr_id")))},eventChange:function(model){$('#invoicesClientsTabsList > [data-id="item-'+model.get("gr_id")+'"]').replaceWith(this.statsTemplate["clientsItemGroup"].call(this,model.toJSON()))},eventAddLoadre:function(){$("#invoicesClientsTabsList",this.el).prepend(this.statsTemplate["buyersGroupsLoader"].call(this));$("#invoicesClientsTabsList #invoicesClientsNewGroup",this.el).hide();$("#invoicesClientsTabsList #invoicesClientsImportBuyers",
this.el).hide()},eventRemoveLoadre:function(){$('#invoicesClientsTabsList [data-sync="buyersGroups"]',this.el).remove();$("#invoicesClientsTabsList #invoicesClientsNewGroup",this.el).show();$("#invoicesClientsTabsList #invoicesClientsImportBuyers",this.el).show()},eventAddLoaderDialog:function(){$("#invoicesClientsDialogAdd").addClass("creating").append(this.statsTemplate["buyersGroupsLoaderDialog"].call(this))},eventRemoveLoaderDialog:function(){$('#invoicesClientsDialogAdd [data-sync="buyersGroups"]').remove();
$("#invoicesClientsDialogAdd").removeClass("creating")},eventAddLoaderImport:function(){$("#invoicesBuyersImportDialog").addClass("upload").append(this.statsTemplate["buyersGroupsLoaderDialog"].call(this))},eventRemoveLoaderImport:function(){$('#invoicesBuyersImportDialog [data-sync="buyersGroups"]').remove();$("#invoicesBuyersImportDialog").removeClass("upload")},statsTemplate:{"clients":_.template(window.Invoices.TEMPLATE["buyersGroups.buyersGroups"]),"clientsItemGroup":_.template(window.Invoices.TEMPLATE["buyersGroups.buyersGroupsItem"]),
"clientsItemGroupEdit":_.template(window.Invoices.TEMPLATE["buyersGroups.buyersGroupsItemEdit"]),"clientsAddGroup":_.template(window.Invoices.TEMPLATE["buyersGroups.buyersGroupsAdd"]),"clientsDelGroup":_.template(window.Invoices.TEMPLATE["buyersGroups.buyersGroupsDel"]),"buyersGroupsLoader":_.template(window.Invoices.TEMPLATE["buyersGroups.buyersGroupsLoader"]),"buyersGroupsLoaderDialog":_.template(window.Invoices.TEMPLATE["buyersGroups.buyersGroupsLoaderDialog"]),"buyersDialogImport":_.template(window.Invoices.TEMPLATE["buyersGroups.buyersDialogImport"])},
l10nHash:{"ru":JSON.parse(window.Invoices.L10N["buyersGroups.ru"])},render:function(group){var self=this;this.el.html(this.statsTemplate["clients"].call(this));this.collection.fetch({add:true,error:function(collection,err){if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},success:function(){self.helperSelected(group)},loader:function(progress){if(progress==0)self.eventAddLoadre.call(self);else if(progress==1)self.eventRemoveLoadre.call(self)}});$("#invoicesClientsTabs",this.el).itabs({elTabs:$("#invoicesClientsTabs #invoicesClientsTabsList",
this.el),selectorItem:'[data-id^="item-"]'});this.helperDialogAdd();this.helperDialogDel();this.helperDialogImport();return this},renderItem:function(group){var self=this;$("#invoicesClientsTabs",this.el).itabs("get","buyers/"+group+"/",function(el){if(!self.collectionBuyers.get(group)){self.collectionBuyers.add({id:group,view:new window.Invoices.viewBuyers({router:self.router,el:$(el)})});self.collectionBuyers.get(group).get("view").render(group)}});this.helperSelected(group);return this},events:{"click #invoicesClientsAddGroup":"eventGroupAdd",
'click #invoicesClientsTabsList [data-name="edit"]':"eventGroupEdit",'click #invoicesClientsTabsList [data-name="delete"]':"eventGroupDel",'blur #invoicesClientsTabsList [name^="name-edit-"]':"eventGroupEditBlur",'keypress #invoicesClientsTabsList [name^="name-edit-"]':"eventGroupEditEnter","click #invoicesBuyersImportDialogOpen":"eventDOMImport"},eventGroupAdd:function(e){$('#invoicesClientsDialogAdd [name="groupName"]').val("");$("#invoicesClientsDialogAdd").dialog("open")},eventGroupEdit:function(e){if($(e.target).attr("data-id")==
1)return;var model=this.collection.get("gr_id",$(e.target).attr("data-id"));$('#invoicesClientsTabsList > [data-id="item-'+model.get("gr_id")+'"]').replaceWith(this.statsTemplate["clientsItemGroupEdit"].call(this,model.toJSON()));$('#invoicesClientsTabsList [data-id="'+model.get("gr_id")+'"]').focus()},eventGroupEditBlur:function(e){if(e.target.done)return;var self=this;e.target.done=true;var model=this.collection.get($(e.target).attr("data-id"));var $c=$('#invoicesClientsTabsList > [data-id="item-'+
model.get("gr_id")+'"]');$(e.target).attr("data-state","load");model.save({"title":$(e.target).val()},{error:function(model,err){if(err.attr)$(e.target).ierror({wrap:true,msg:self.helperGetError.call(self,model,err)});if(err.error==1||err.msg)$.ierrorDialog("add",err.msg);if(e.target)e.target.done=false},success:function(model){self.eventChange.call(self,model);self.helperSelected.call(self,self.helperSelectedNumber);if(e.target)e.target.done=false},loader:function(progress){if(progress==0)$c.addClass("saving");
else if(progress==1)$c.removeClass("saving")}})},eventGroupEditEnter:function(e){if(e.which!=13)return;this.eventGroupEditBlur.call(this,e)},eventGroupDel:function(e){if(this.helperGroupDelModel)return;this.helperGroupDelModel=this.collection.get($(e.target).attr("data-id"));$('#invoicesClientsDialogDel [name="groupDelForce"]').get(0).checked=false;$("#invoicesClientsDialogDel").dialog("open")},eventDOMImport:function(e){$('#invoicesBuyersImportDialog [type="file"]').ierror("remove").val("");$("#invoicesBuyersImportDialog").dialog("open")},
helperDialogAdd:function(){this.el.append(this.statsTemplate["clientsAddGroup"].call(this));var self=this;var $e=$('#invoicesClientsDialogAdd [name="groupName"]');$("#invoicesClientsDialogAdd",this.el).iplaceholder().dialog({autoOpen:false,resizable:false,modal:true,draggable:false,buttons:{Add:function(){var dialog=this;self.collection.create({title:$e.val()},{error:function(model,err){if(err.attr)$e.ierror({wrap:true,msg:self.helperGetError.call(self,model,err)});if(err.error==1||err.msg)$.ierrorDialog("add",
err.msg)},success:function(model){$(dialog).dialog("close")},loader:function(progress){if(progress==0)self.eventAddLoaderDialog.call(self);else if(progress==1)self.eventRemoveLoaderDialog.call(self)}})},Cancel:function(){$(this).dialog("close")}}})},helperDialogDel:function(){this.el.append(this.statsTemplate["clientsDelGroup"].call(this));var collection=this.collection;var self=this;$("#invoicesClientsDialogDel",this.el).dialog({autoOpen:false,resizable:false,modal:true,draggable:false,buttons:{Remove:function(){var del_force=
$('#invoicesClientsDialogDel [name="groupDelForce"]:checked').size();var dialog=this;var $c=$('#invoicesClientsTabsList > [data-id="item-'+self.helperGroupDelModel.get("gr_id")+'"]',self.el);self.helperGroupDelModel.set({"buyers":del_force});self.helperGroupDelModel.destroy({error:function(model,err){if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},success:function(model){if(self.helperSelectedNumber==model.id){if(del_force)self.collectionBuyers.remove(self.collectionBuyers.get(1));self.router.navigate("buyers/1/",
true)}},loader:function(progress){if(progress==0)$c.addClass("removing");else if(progress==1)$c.removeClass("removing")}});self.helperGroupDelModel=undefined;$(dialog).dialog("close")},Cancel:function(){self.helperGroupDelModel=undefined;$(this).dialog("close")}}})},helperGroupDelModel:undefined,helperSelected:function(id){$("#invoicesClientsTabs",this.el).itabs("select","buyers/"+id+"/");this.helperSelectedNumber=id},helperSelectedNumber:0,helperDialogImport:function(){this.el.append(this.statsTemplate["buyersDialogImport"].call(this));
var self=this;var $form=$("#invoicesUpload").clone(true).show().appendTo($('[data-id="form"]',$dialog)).attr("id","invoicesBuyersImportForm");var $dialog=$("#invoicesBuyersImportDialog",this.el).dialog({autoOpen:false,resizable:false,modal:true,draggable:false,buttons:[{text:"Import",click:function(){var dialog=this;var val=$('[type="file"]',$form).val(),ftype=((val||"").substr(val.length-4,4)||"").toLowerCase();if(ftype!=".csv"&&ftype!=".vcf"){$('[type="file"]',$form).ierror({wrap:true,msg:self.helperGetError.call(self,
null,{attr:"import"})});return}self.eventAddLoaderImport.call(self);$.ajax({url:"https://pulyaev.test.liqpay.com/?do=invoices&act=ajax",fileInput:$('[type="file"]',$form),formData:[{name:"json",value:JSON.stringify({subname:"import_buyers",inputfile:$('[type="file"]',$form).attr("name"),data:{encoding:$('[name="encoding"]',dialog).val(),filetype:ftype.substr(ftype.length-3,3)}})}],paramName:"file",type:"POST",dataType:"iframe",success:function(data){try{data=JSON.parse($(data).text())||{}}catch(E){alert(E);
return}data.data=data.data||{};if(data.data.error||data.data.errors)$('[type="file"]',$form).ierror({wrap:true,msg:data.data.msg||data.data.errors});else{self.collectionBuyers.remove(self.collectionBuyers.get(1));self.router.navigate("buyers/1/",true)}},error:function(jqXHR){console.error("ERROR: %o",jqXHR)},complete:function(){$('[type="file"]',$form).val("");self.eventRemoveLoaderImport.call(self)}})}},{text:"Cancel",click:function(){$dialog.dialog("close")}}]})},helperGetError:function(model,err){if(err.attr==
"title")if(err.arg)return"Buyer group duplication";else return"Buyer group title - incorrect";else if(err.attr=="import")return"File import buyers - incorrect"}});window.Invoices.ModelBuyers=Backbone.Model.extend({defaults:{b_uid:null,img_url:"",name:"",phone_main:null,email:null,addr:null,comment:null},idAttribute:"b_uid",syncArg:{"read":null,"create":"new_buyers","update":"edit_buyers","delete":"del_buyers"},syncFilter:{"create":{there:["name","phone_main","email","addr","comment","gr_id"]},"update":{there:["b_uid","name","phone_main","email","addr","comment"]},"delete":{there:["b_uid"]}},validate:function(attrs){if(attrs.name!==undefined)if(!/^[\w\s\u0430-\u044f\u0410-\u042f\u0451\u0401\.,\(\)]+$/i.test(attrs.name||
""))return{attr:"name"};if(this.unvalid(attrs.email)&&this.unvalid(attrs.phone_main))if(this.forInLength(attrs)===1&&attrs["b_uid"]>0||attrs["error"]==0);else{if(!/^\+[0-9]{12,12}$/i.test(attrs.phone_main))return{attr:"phone_main"};if(!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(attrs.email))return{attr:"email"}}else if(this.unvalid(attrs.email)&&!this.unvalid(attrs.phone_main)){if(!/^\+[0-9]{12,12}$/i.test(attrs.phone_main))return{attr:"phone_main"}}else if(!this.unvalid(attrs.email)&&
this.unvalid(attrs.phone_main)){if(!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(attrs.email))return{attr:"email"}}else if(!this.unvalid(attrs.email)&&!this.unvalid(attrs.phone_main)){if(!/^\+[0-9]{12,12}$/i.test(attrs.phone_main))return{attr:"phone_main"};if(!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(attrs.email))return{attr:"email"}}},
unvalid:function(arg){return arg===undefined||arg===null},forInLength:function(arg){var j=0;for(var i in arg)j++;return j}});window.Invoices.CollectionBuyers=Backbone.Collection.extend({model:window.Invoices.ModelBuyers,initialize:function(){},syncArg:{"read":"data_buyers"}});window.Invoices.viewBuyers=Backbone.View.extend({initialize:function(opt){this.router=opt.router;this.collection=new window.Invoices.CollectionBuyers;this.collection.bind("add",this.eventAdd,this);this.collection.bind("remove",this.eventRemove,this);this.collection.bind("change",this.eventChange,this)},eventAdd:function(model){$('#invoicesClientsTbody [data-state="new"]',this.el).before(this.statsTemplate["clientsContactsItem"].call(this,model.toJSON()))},eventRemove:function(model){$('#invoicesClientsTbody > [data-id="'+
model.get("b_uid")+'"]',this.el).remove()},eventChange:function(model){$('#invoicesClientsTbody > [data-id="'+model.get("b_uid")+'"]',this.el).replaceWith(this.statsTemplate["clientsContactsItem"].call(this,model.toJSON()))},eventChangeEdit:function(model){$('#invoicesClientsTbody > [data-id="'+model.get("b_uid")+'"]',this.el).replaceWith(this.statsTemplate["clientsContactsItemEdit"].call(this,model.toJSON()));$('#invoicesClientsTbody > [data-id="'+model.get("b_uid")+'"]',this.el).iplaceholder()},
eventNew:function(){$("#invoicesClientsTbody",this.el).append(this.statsTemplate["clientsContactsItemNew"].call(this)).iplaceholder()},eventAddLoadre:function(){$("#invoicesClientsTbody",this.el).append(this.statsTemplate["buyersLoader"].call(this));$('#invoicesClientsTbody [data-state="new"]',this.el).hide()},eventRemoveLoadre:function(){$('#invoicesClientsTbody [data-sync="buyers"]',this.el).remove();$('#invoicesClientsTbody [data-state="new"]',this.el).show()},statsTemplate:{"clientsContacts":_.template(window.Invoices.TEMPLATE["buyers.buyers"]),
"clientsContactsItem":_.template(window.Invoices.TEMPLATE["buyers.buyersItem"]),"clientsContactsItemEdit":_.template(window.Invoices.TEMPLATE["buyers.buyersItemEdit"]),"clientsContactsItemNew":_.template(window.Invoices.TEMPLATE["buyers.buyersItemNew"]),"clientsContactsDel":_.template(window.Invoices.TEMPLATE["buyers.buyersDel"]),"buyersLoader":_.template(window.Invoices.TEMPLATE["buyers.buyersLoader"])},render:function(group){var self=this;this.el.html(this.statsTemplate["clientsContacts"].call(this));
this.eventNew.call(this);this.collection.fetch({data:{gr_id:group},add:true,error:function(collection,err){if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},loader:function(progress){if(progress==0)self.eventAddLoadre.call(self);else if(progress==1)self.eventRemoveLoadre.call(self)}});this.helperGroup=group;this.helperDialogDel();return this},events:{'click [data-name="save"]':"eventSaveItem",'click [data-name="del"]':"eventDeleteItem",'click [data-name="edit"]':"eventEditItem",'change [name="name"]':"eventSaveItemModel",
'change [name="email"]':"eventSaveItemModel",'change [name="phone_main"]':"eventSaveItemModel",'change [name="addr"]':"eventSaveItemModel",'change [name="comment"]':"eventSaveItemModel"},helperGroup:0,helperItemDelModel:undefined,eventDeleteItem:function(e){if(this.helperItemDelModel)return;var model=this.collection.get($(e.target).attr("data-id"));if(model){this.helperItemDelModel=model;$("#invoicesClientsContactsDialogDel-"+this.helperGroup).dialog("open")}},eventSaveItem:function(e){var self=this,
model=this.collection.get($(e.target).attr("data-id"));if(model){if(e.target.done)return;e.target.done=true;var $c=$('#invoicesClientsTbody > [data-id="'+model.get("b_uid")+'"]',this.el);model.save(model.toJSON(),{error:function(model,err){if(err.attr)$('input[name="'+err.attr+'"]',$c).ierror({wrap:true,msg:self.helperGetError.call(self,model,err)});if(err.error==1||err.msg)$.ierrorDialog("add",err.msg);if(e.target.done)e.target.done=false},success:function(){model.change();if(e.target.done)e.target.done=
false},loader:function(progress){if(progress==0)$c.addClass("saving");else if(progress==1)$c.removeClass("saving")}})}else this.helperNewModel.call(this,e.target,false)},eventEditItem:function(e){var model=this.collection.get($(e.target).attr("data-id"));if(model)this.eventChangeEdit.call(this,model)},eventSaveItemModel:function(e){var self=this,model=this.collection.get($(e.target).attr("data-id"));if(model){var arg=model.attributes,$c=$('#invoicesClientsTbody > [data-id="'+model.get("b_uid")+'"]',
this.el);arg[$(e.target).attr("name")]=$(e.target).val()||null;if(arg["email"]===null&&arg["phone_main"]==null)arg["phone_main"]="";model.set(arg,{error:function(model,err){$(e.target).ierror({wrap:true,msg:self.helperGetError.call(self,model,err)})}})}else this.helperNewModel.call(this,e.target,true)},eventSaveItemModelEnter:function(e){if(e.which!=13)return;this.eventSaveItemModel.call(this,e)},helperNewModel:function(el,change){var data={},self=this,$c=this.helperSearchNewModel($(el),0);if(!$c||
$c.attr("data-state")!="new")return;$c.attr("data-state","saving");$('input[type="text"], textarea',$c).each(function(){data[$(this).attr("name")]=$(this).val()||null});data["gr_id"]=this.helperGroup;var res=this.collection.create(data,{error:function(model,err){$c.attr("data-state","new");if(err.attr&&!change)$('input[name="'+err.attr+'"]',$c).ierror({wrap:true,msg:self.helperGetError.call(self,model,err)});if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},success:function(model,res){$c.removeAttr("data-state");
$("input, textarea, [data-name]",$c).attr("data-id",model.get("b_uid"));$c.attr("data-id",model.get("b_uid"));self.eventNew.call(self)},loader:function(progress){if(progress==0)$c.addClass("creating");else if(progress==1)$c.removeClass("creating")}});if(!res)$c.attr("data-state","new");else{var $el=$('[name="phone_main"]',$c);if(!$el.val())$el.ierror("remove")}},helperSearchNewModel:function(el,i){i++;if(i>7)return null;if(el.attr("data-state"))return el;else return this.helperSearchNewModel(el.parent(),
i)},helperDialogDel:function(){this.el.append(this.statsTemplate["clientsContactsDel"].call(this,{id:this.helperGroup}));var collection=this.collection;var self=this;$("#invoicesClientsContactsDialogDel-"+this.helperGroup,this.el).dialog({autoOpen:false,resizable:false,modal:true,draggable:false,buttons:{Remove:function(){var dialog=this;var $c=$('#invoicesClientsTbody > [data-id="'+self.helperItemDelModel.get("b_uid")+'"]',self.el);self.helperItemDelModel.destroy({error:function(model,err){if(err.error==
1||err.msg)$.ierrorDialog("add",err.msg)},success:function(model){},loader:function(progress){if(progress==0)$c.addClass("removing");else if(progress==1)$c.removeClass("removing")}});self.helperItemDelModel=undefined;$(dialog).dialog("close")},Cancel:function(){self.helperItemDelModel=undefined;$(this).dialog("close")}}})},helperGetError:function(model,err){switch(err.attr){case "name":return"Buyer name - incorrect";case "email":return"Buyer email - incorrect";case "phone_main":return"Buyer phone - incorrect"}}});window.Invoices.ModelGoodsGroups=Backbone.Model.extend({defaults:{gr_id:null,title:"new group"},idAttribute:"gr_id",syncArg:{"read":null,"create":"new_group_gds","update":"edit_group_gds","delete":"del_group_gds"},syncFilter:{"create":{there:["title"]},"update":{there:["gr_id","title"]},"delete":{there:["gr_id","goods"]}},validate:function(attrs){attrs=attrs||{};if(!/^[\w\s\u0430-\u044f\u0410-\u042f\u0451\u0401]+$/i.test(attrs.title))return{attr:"title"};var model=this.collection.get("title",attrs.title);
if(model&&this.get("gr_id")!=model.get("gr_id"))return{attr:"title",arg:true}}});window.Invoices.CollectionGoodsGroups=Backbone.Collection.extend({model:window.Invoices.ModelGoodsGroups,initialize:function(){},syncArg:{"read":"data_group_gds"}});window.Invoices.ViewGoodsGroups=Backbone.View.extend({initialize:function(opt){this.router=opt.router;this.collection=new window.Invoices.CollectionGoodsGroups;this.collectionGoodss=new window.Invoices.CollectionRouters;this.collection.bind("add",this.eventAdd,this);this.collection.bind("remove",this.eventRemove,this)},eventAdd:function(model){$("#invoicesGoodsGroupsTabsList #invoicesGoodsGroupsNewGroup",this.el).before(this.statsTemplate["clientsItemGroup"].call(this,model.toJSON()))},eventRemove:function(model){$('#invoicesGoodsGroupsTabsList > [data-id="item-'+
model.get("gr_id")+'"]',this.el).remove();this.collectionGoodss.remove(this.collectionGoodss.get(model.get("gr_id")))},eventChange:function(model){$('#invoicesGoodsGroupsTabsList > [data-id="item-'+model.get("gr_id")+'"]').replaceWith(this.statsTemplate["clientsItemGroup"].call(this,model.toJSON()))},eventAddLoadre:function(){$("#invoicesGoodsGroupsTabsList",this.el).prepend(this.statsTemplate["goodsGroupsLoader"].call(this));$("#invoicesGoodsGroupsTabsList #invoicesGoodsGroupsNewGroup",this.el).hide()},
eventRemoveLoadre:function(){$('#invoicesGoodsGroupsTabsList [data-sync="goodsGroups"]',this.el).remove();$("#invoicesGoodsGroupsTabsList #invoicesGoodsGroupsNewGroup",this.el).show()},eventAddLoaderDialog:function(){$("#invoicesGoodsGroupsDialogAdd").addClass("creating").append(this.statsTemplate["goodsGroupsLoaderDialog"].call(this))},eventRemoveLoaderDialog:function(){$('#invoicesGoodsGroupsDialogAdd [data-sync="goodsGroups"]').remove();$("#invoicesGoodsGroupsDialogAdd").removeClass("creating")},
statsTemplate:{"clients":_.template(window.Invoices.TEMPLATE["goodsGroups.goodsGroups"]),"clientsItemGroup":_.template(window.Invoices.TEMPLATE["goodsGroups.goodsGroupsItem"]),"clientsItemGroupEdit":_.template(window.Invoices.TEMPLATE["goodsGroups.goodsGroupsItemEdit"]),"clientsAddGroup":_.template(window.Invoices.TEMPLATE["goodsGroups.goodsGroupsAdd"]),"clientsDelGroup":_.template(window.Invoices.TEMPLATE["goodsGroups.goodsGroupsDel"]),"goodsGroupsLoader":_.template(window.Invoices.TEMPLATE["goodsGroups.goodsGroupsLoader"]),
"goodsGroupsLoaderDialog":_.template(window.Invoices.TEMPLATE["goodsGroups.goodsGroupsLoaderDialog"])},l10nHash:{"ru":JSON.parse(window.Invoices.L10N["goodsGroups.ru"])},render:function(group){var self=this;this.el.html(this.statsTemplate["clients"].call(this));this.collection.fetch({add:true,error:function(collection,err){if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},success:function(){self.helperSelected(group)},loader:function(progress){if(progress==0)self.eventAddLoadre.call(self);else if(progress==
1)self.eventRemoveLoadre.call(self)}});$("#invoicesGoodsGroupsTabs",this.el).itabs({elTabs:$("#invoicesGoodsGroupsTabs #invoicesGoodsGroupsTabsList",this.el),selectorItem:'[data-id^="item-"]'});this.helperDialogAdd();this.helperDialogDel();return this},renderItem:function(group){var self=this;$("#invoicesGoodsGroupsTabs",this.el).itabs("get","goods/"+group+"/",function(el){if(!self.collectionGoodss.get(group)){self.collectionGoodss.add({id:group,view:new window.Invoices.viewGoods({router:self.router,
el:$(el)})});self.collectionGoodss.get(group).get("view").render(group)}});this.helperSelected(group);return this},events:{"click #invoicesGoodsGroupsAddGroup":"eventGroupAdd",'click #invoicesGoodsGroupsTabsList [data-name="edit"]':"eventGroupEdit",'click #invoicesGoodsGroupsTabsList [data-name="delete"]':"eventGroupDel",'blur #invoicesGoodsGroupsTabsList [name^="name-edit-"]':"eventGroupEditBlur",'keypress #invoicesGoodsGroupsTabsList [name^="name-edit-"]':"eventGroupEditEnter"},eventGroupAdd:function(e){$('#invoicesGoodsGroupsDialogAdd [name="groupName"]').val("");
$("#invoicesGoodsGroupsDialogAdd").dialog("open")},eventGroupEdit:function(e){if($(e.target).attr("data-id")==1)return;var model=this.collection.get("gr_id",$(e.target).attr("data-id"));$('#invoicesGoodsGroupsTabsList > [data-id="item-'+model.get("gr_id")+'"]').replaceWith(this.statsTemplate["clientsItemGroupEdit"].call(this,model.toJSON()));$('#invoicesGoodsGroupsTabsList [data-id="'+model.get("gr_id")+'"]').focus()},eventGroupEditBlur:function(e){if(e.target.done)return;var self=this;e.target.done=
true;var model=this.collection.get($(e.target).attr("data-id"));var $c=$('#invoicesGoodsGroupsTabsList > [data-id="item-'+model.get("gr_id")+'"]');$(e.target).attr("data-state","load");model.save({"title":$(e.target).val()},{error:function(model,err){if(err.attr)$(e.target).ierror({wrap:true,msg:self.helperGetError.call(self,model,err)});if(err.error==1||err.msg)$.ierrorDialog("add",err.msg);if(e.target)e.target.done=false},success:function(model){self.eventChange.call(self,model);self.helperSelected.call(self,
self.helperSelectedNumber);if(e.target)e.target.done=false},loader:function(progress){if(progress==0)$c.addClass("saving");else if(progress==1)$c.removeClass("saving")}})},eventGroupEditEnter:function(e){if(e.which!=13)return;this.eventGroupEditBlur.call(this,e)},eventGroupDel:function(e){if(this.helperGroupDelModel)return;this.helperGroupDelModel=this.collection.get($(e.target).attr("data-id"));$('#invoicesGoodsGroupsDialogDel [name="groupDelForce"]').get(0).checked=false;$("#invoicesGoodsGroupsDialogDel").dialog("open")},
helperDialogAdd:function(){this.el.append(this.statsTemplate["clientsAddGroup"].call(this));var self=this;var $e=$('#invoicesGoodsGroupsDialogAdd [name="groupName"]');$("#invoicesGoodsGroupsDialogAdd",this.el).iplaceholder().dialog({autoOpen:false,resizable:false,modal:true,draggable:false,buttons:{Add:function(){var dialog=this;self.collection.create({title:$e.val()},{error:function(model,err){if(err.attr)$($e.get(0)).ierror({wrap:true,msg:self.helperGetError.call(self,model,err)});if(err.error==
1||err.msg)$.ierrorDialog("add",err.msg)},success:function(model){$(dialog).dialog("close")},loader:function(progress){if(progress==0)self.eventAddLoaderDialog.call(self);else if(progress==1)self.eventRemoveLoaderDialog.call(self)}})},Cancel:function(){$(this).dialog("close")}}})},helperDialogDel:function(){this.el.append(this.statsTemplate["clientsDelGroup"].call(this));var collection=this.collection;var self=this;$("#invoicesGoodsGroupsDialogDel",this.el).dialog({autoOpen:false,resizable:false,
modal:true,draggable:false,buttons:{Remove:function(){var del_force=$('#invoicesGoodsGroupsDialogDel [name="groupDelForce"]:checked').size();var dialog=this;var $c=$('#invoicesGoodsGroupsTabsList > [data-id="item-'+self.helperGroupDelModel.get("gr_id")+'"]',self.el);self.helperGroupDelModel.set({"goods":del_force});self.helperGroupDelModel.destroy({error:function(model,err){if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},success:function(model){if(self.helperSelectedNumber==model.id){if(!del_force)self.collectionGoodss.remove(self.collectionGoodss.get(1));
self.router.navigate("goods/1/",true)}},loader:function(progress){if(progress==0)$c.addClass("removing");else if(progress==1)$c.removeClass("removing")}});self.helperGroupDelModel=undefined;$(dialog).dialog("close")},Cancel:function(){self.helperGroupDelModel=undefined;$(this).dialog("close")}}})},helperGroupDelModel:undefined,helperSelected:function(id){$("#invoicesGoodsGroupsTabs",this.el).itabs("select","goods/"+id+"/");this.helperSelectedNumber=id},helperSelectedNumber:0,helperGetError:function(model,
err){if(err.attr=="title")if(err.arg)return"Goods group duplication";else return"Goods group title - incorrect"}});window.Invoices.ModelGoods=Backbone.Model.extend({defaults:{gds_uid:null,title:"",price:"0.00",units:"",img_url:null,desc_url:null},idAttribute:"gds_uid",syncArg:{"read":null,"create":"new_goods","update":"edit_goods","delete":"del_goods"},syncFilter:{"create":{there:["title","price","units","desc_url","gr_id"]},"update":{there:["gds_uid","title","price","units","desc_url"]},"delete":{there:["gds_uid"]}},validate:function(attrs){if(attrs.title!==undefined&&!/^[\w\s\u0430-\u044f\u0410-\u042f\u0451\u0401]+$/i.test(attrs.title))return{attr:"title"};
if(attrs.units!==undefined&&!/^[a-zA-Z0-9\u0430-\u044f\u0410-\u042f\u0451\u0401\.,-_;:]{1,5}$/i.test(attrs.units||""))return{attr:"units"};if(attrs.price!==undefined&&!/^([0-9]+|[0-9]+\.[0-9]{0,2})$/i.test(attrs.price+"")||attrs.price==0)return{attr:"price"};if(attrs.desc_url&&!/^(([\w]+:)?\/\/)?(([\d\w]|%[a-fA-f\d]{2,2})+(:([\d\w]|%[a-fA-f\d]{2,2})+)?@)?([\d\w][-\d\w]{0,253}[\d\w]\.)+[\w]{2,4}(:[\d]+)?(\/([-+_~.\d\w]|%[a-fA-f\d]{2,2})*)*(\?(&?([-+_~.\d\w]|%[a-fA-f\d]{2,2})=?)*)?$/.test(attrs.desc_url))return{attr:"desc_url"}}});window.Invoices.CollectionGoods=Backbone.Collection.extend({model:window.Invoices.ModelGoods,initialize:function(){},syncArg:{"read":"data_goods"}});window.Invoices.viewGoods=Backbone.View.extend({initialize:function(opt){this.router=opt.router;this.collection=new window.Invoices.CollectionGoods;this.collection.bind("add",this.eventAdd,this);this.collection.bind("remove",this.eventRemove,this);this.collection.bind("change",this.eventChange,this)},eventAdd:function(model){$('#invoicesGoodsTbody [data-state="new"]',this.el).before(this.statsTemplate["clientsContactsItem"].call(this,model.toJSON()))},eventRemove:function(model){$('#invoicesGoodsTbody > [data-id="'+
model.get("gds_uid")+'"]',this.el).remove()},eventChange:function(model){$('#invoicesGoodsTbody > [data-id="'+model.get("gds_uid")+'"]',this.el).replaceWith(this.statsTemplate["clientsContactsItem"].call(this,model.toJSON()))},eventChangeEdit:function(model){$('#invoicesGoodsTbody > [data-id="'+model.get("gds_uid")+'"]',this.el).replaceWith(this.statsTemplate["clientsContactsItemEdit"].call(this,model.toJSON()));$('#invoicesGoodsTbody > [data-id="'+model.get("gds_uid")+'"]',this.el).iplaceholder()},
eventNew:function(){$("#invoicesGoodsTbody",this.el).append(this.statsTemplate["clientsContactsItemNew"].call(this)).iplaceholder()},eventAddLoadre:function(){$("#invoicesGoodsTbody",this.el).append(this.statsTemplate["goodsLoader"].call(this));$('#invoicesGoodsTbody [data-state="new"]',this.el).hide()},eventRemoveLoadre:function(){$('#invoicesGoodsTbody [data-sync="goods"]',this.el).remove();$('#invoicesGoodsTbody [data-state="new"]',this.el).show()},statsTemplate:{"clientsContacts":_.template(window.Invoices.TEMPLATE["goods.goods"]),
"clientsContactsItem":_.template(window.Invoices.TEMPLATE["goods.goodsItem"]),"clientsContactsItemEdit":_.template(window.Invoices.TEMPLATE["goods.goodsItemEdit"]),"clientsContactsItemNew":_.template(window.Invoices.TEMPLATE["goods.goodsItemNew"]),"clientsContactsDel":_.template(window.Invoices.TEMPLATE["goods.goodsDel"]),"goodsLoader":_.template(window.Invoices.TEMPLATE["goods.goodsLoader"])},render:function(group){var self=this;this.el.html(this.statsTemplate["clientsContacts"].call(this));this.eventNew.call(this);
this.collection.fetch({data:{gr_id:group},add:true,error:function(collection,err){if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},loader:function(progress){if(progress==0)self.eventAddLoadre.call(self);else if(progress==1)self.eventRemoveLoadre.call(self)}});this.helperGroup=group;this.helperDialogDel();return this},events:{'click [data-name="save"]':"eventSaveItem",'click [data-name="del"]':"eventDeleteItem",'click [data-name="edit"]':"eventEditItem",'change [name="title"]':"eventSaveItemModel",
'change [name="units"]':"eventSaveItemModel",'change [name="price"]':"eventSaveItemModel",'change [name="desc_url"]':"eventSaveItemModel"},helperGroup:0,helperItemDelModel:undefined,eventDeleteItem:function(e){if(this.helperItemDelModel)return;var model=this.collection.get($(e.target).attr("data-id"));if(model){this.helperItemDelModel=model;$("#invoicesGoodsDialogDel-"+this.helperGroup).dialog("open")}},eventSaveItem:function(e){var self=this,model=this.collection.get($(e.target).attr("data-id"));
if(model){if(e.target.done)return;e.target.done=true;var $c=$('#invoicesGoodsTbody > [data-id="'+model.get("gds_uid")+'"]',this.el);model.save(model.toJSON(),{error:function(model,err,arg){if(err.attr)$('input[name="'+err.attr+'"], textarea[name="'+err.attr+'"]',$c).ierror({wrap:true,msg:self.helperGetError.call(self,model,err)});if(err.error==1||err.msg)$.ierrorDialog("add",err.msg);if(e.target.done)e.target.done=false},success:function(model){model.change();if(e.target.done)e.target.done=false},
loader:function(progress){if(progress==0)$c.addClass("saving");else if(progress==1)$c.removeClass("saving")}})}else this.helperNewModel.call(this,e.target,false)},eventEditItem:function(e){var model=this.collection.get($(e.target).attr("data-id"));if(model)this.eventChangeEdit.call(this,model)},eventSaveItemModel:function(e){var self=this,model=this.collection.get($(e.target).attr("data-id"));if(model){var arg=model.attributes,$c=$('#invoicesGoodsTbody > [data-id="'+model.get("gds_uid")+'"]',this.el);
arg[$(e.target).attr("name")]=$(e.target).val()||null;if(arg["title"]===null)arg["title"]="";model.set(arg,{error:function(model,err){$('input[name="'+err.attr+'"], textarea[name="'+err.attr+'"]',$c).ierror({wrap:true,msg:self.helperGetError.call(self,model,err)})}})}else this.helperNewModel.call(this,e.target,true)},eventSaveItemModelEnter:function(e){if(e.which!=13)return;this.eventSaveItemModel.call(this,e)},helperNewModel:function(el,change){var data={},self=this,$c=this.helperSearchNewModel($(el),
0);if(!$c||$c.attr("data-state")!="new")return;$c.attr("data-state","saving");$('input[type="text"], textarea',$c).each(function(){data[$(this).attr("name")]=$(this).val()||null});if(data["title"]===null)data["title"]="";if(data["units"]===null)data["units"]="pcs.";data["gr_id"]=this.helperGroup;var res=this.collection.create(data,{error:function(model,err){$c.attr("data-state","new");if(err.attr&&!change)$('input[name="'+err.attr+'"], textarea[name="'+err.attr+'"]',$c).ierror({wrap:true,msg:self.helperGetError.call(self,
model,err)});if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},success:function(model,res){$c.removeAttr("data-state");$("input, textarea, [data-name]",$c).attr("data-id",model.get("gds_uid"));$c.attr("data-id",model.get("gds_uid"));$('[data-name="id"]',$c).html(model.get("gds_uid"));self.eventNew.call(self)},loader:function(progress){if(progress==0)$c.addClass("creating");else if(progress==1)$c.removeClass("creating")}});if(!res)$c.attr("data-state","new")},helperSearchNewModel:function(el,
i){i++;if(i>7)return null;if(el.attr("data-state"))return el;else return this.helperSearchNewModel(el.parent(),i)},helperDialogDel:function(){this.el.append(this.statsTemplate["clientsContactsDel"].call(this,{id:this.helperGroup}));var collection=this.collection;var self=this;$("#invoicesGoodsDialogDel-"+this.helperGroup,this.el).dialog({autoOpen:false,resizable:false,modal:true,draggable:false,buttons:{Remove:function(){var dialog=this;var $c=$('#invoicesGoodsTbody > [data-id="'+self.helperItemDelModel.get("gds_uid")+
'"]',self.el);self.helperItemDelModel.destroy({error:function(model,err){if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},success:function(model){},loader:function(progress){if(progress==0)$c.addClass("removing");else if(progress==1)$c.removeClass("removing")}});self.helperItemDelModel=undefined;$(dialog).dialog("close")},Cancel:function(){self.helperItemDelModel=undefined;$(this).dialog("close")}}})},helperGetError:function(model,err){switch(err.attr){case "title":return"Goods title - incorrect";
case "units":return"Goods units - incorrect";case "price":return"Goods price - incorrect";case "desc_url":return"Goods desc_url - incorrect"}}});window.Invoices.ModelInvoicesStatus=Backbone.Model.extend({defaults:{id:0,name:"unknown status",title:"unknown title"}});window.Invoices.CollectionInvoicesStatus=Backbone.Collection.extend({model:window.Invoices.ModelInvoicesStatus,initialize:function(){this.add([{id:1,name:"created",title:"created"},{id:2,name:"issued",title:"issued"},{id:3,name:"paid",title:"paid"},{id:4,name:"expired",title:"expired"},{id:5,name:"closed",title:"closed"}])}});window.Invoices.ViewInvoicesStatus=Backbone.View.extend({initialize:function(opt){this.router=opt.router;this.collection=new window.Invoices.CollectionInvoicesStatus},statsTemplate:{"invoicesStatus":_.template(window.Invoices.TEMPLATE["invoicesStatus.invoicesStatus"])},render:function(){this.el.html(this.statsTemplate["invoicesStatus"].call(this,this.collection));$("#invoicesInvoicesTabs",this.el).itabs({elTabs:$("#invoicesInvoicesTabs #invoicesInvoicesTabsList",this.el),selectorItem:"[data-id]"});
return this},renderItem:function(st){var self=this,status;if(!_.include(this.collection.pluck("name"),st))st=0;status=st==0?"all":st;$("#invoicesInvoicesTabs",this.el).itabs("get","invoices/"+status+"/",function(el){var view=new window.Invoices.ViewInvoices({router:self.router,el:$(el)});view.render(st,status)});$("#invoicesInvoicesTabs",this.el).itabs("select","invoices/"+status+"/");return this}});window.Invoices.ModelInvoices=Backbone.Model.extend({defaults:{inv_uid:null,currency:"UAH",b_uid:0,total:"0.00",descr:null,msg:null,status:null,closed_at:null,created_at:null,paid_at:null,issued_at:null,expired_at:null,buyers:[]},idAttribute:"inv_uid",syncArg:{"update":"issue_invoice"},syncFilter:{"update":{there:["inv_uid"]}}});window.Invoices.CollectionInvoices=Backbone.Collection.extend({model:window.Invoices.ModelInvoices,initialize:function(){},syncArg:{"read":"data_invoice_ex"}});window.Invoices.ViewInvoices=Backbone.View.extend({initialize:function(opt){this.router=opt.router;this.collection=new window.Invoices.CollectionInvoices;this.collection.bind("add",this.eventAdd,this);this.collection.bind("remove",this.eventRemove,this);this.collection.bind("change",this.eventChange,this)},eventAdd:function(model){this.helperPrepareBinfo(model);$("#invoicesInvoicesTbody",this.el).append(this.statsTemplate["invoicesItem"].call(this,model.toJSON()))},eventRemove:function(model){$('#invoicesInvoicesTbody [data-id="'+
model.get("inv_uid")+'"]',this.el).remove()},eventChange:function(model){if(this.helperStatus=="created")this.eventRemove(model);else $('#invoicesInvoicesTbody > [data-id="'+model.get("inv_uid")+'"]').replaceWith(this.statsTemplate["invoicesItem"].call(this,model.toJSON()))},eventAddLoader:function(){$("#invoicesInvoicesTbody",this.el).append(this.statsTemplate["invoicesLoader"].call(this))},eventRemoveLoader:function(){$('#invoicesInvoicesTbody [data-sync="invoices"]',this.el).remove()},statsTemplate:{"invoices":_.template(window.Invoices.TEMPLATE["invoices.invoices"]),
"invoicesItem":_.template(window.Invoices.TEMPLATE["invoices.invoicesItem"]),"invoicesLoader":_.template(window.Invoices.TEMPLATE["invoices.invoicesLoader"])},render:function(st,status){var self=this;this.el.html(this.statsTemplate["invoices"].call(this));var data=st===0?{}:{status:status};this.collection.fetch({data:data,add:true,error:function(collection,err){},loader:function(progress){if(progress==0)self.eventAddLoader.call(self);else if(progress==1)self.eventRemoveLoader.call(self)}});this.helperStatus=
status;return this},events:{'click [data-name="issued"]':"eventUpdateItem"},helperPrepareBinfo:function(model){var binfo=model.get("b_info");if(binfo&&binfo.length>0){binfo=JSON.parse(binfo)||[];if(!(binfo instanceof Array))binfo=[binfo];model.set({buyers:binfo},{silent:true})}else model.set({buyers:[]},{silent:true})},helperStatus:undefined,eventUpdateItem:function(e){var model=this.collection.get($(e.target).attr("data-id"));var $c=$('#invoicesInvoicesTbody [data-id="'+model.get("inv_uid")+'"]',
this.el);model.set({status:"issued",issued_at:date("Y-m-d H:i:s",new Date)},{silent:true});model.save(null,{error:function(model,err){},loader:function(progress){if(progress==0)$c.addClass("saving");else if(progress==1)$c.removeClass("saving")}})}});window.Invoices.ModelInvoiceBuyer=Backbone.Model.extend({defaults:{nid:0,b_uid:null,img_url:"",name:null,phone_main:null,email:null,addr:null,comment:null},idAttribute:"b_uid",syncArg:{"create":"new_buyers"},syncFilter:{"create":{there:["name","phone_main","email","addr","comment","gr_id"]},"new":{there:[]},"item":{there:["b_uid"]}},validate:function(attrs){if(attrs.name!==undefined)if(!/^[\w\s\u0430-\u044f\u0410-\u042f\u0451\u0401\.,\(\)]+$/i.test(attrs.name||""))return{attr:"name"};if(this.unvalid(attrs.email)&&
this.unvalid(attrs.phone_main))if(this.forInLength(attrs)===1&&attrs["b_uid"]>0||attrs["error"]==0);else{if(!/^\+[0-9]{12,12}$/i.test(attrs.phone_main))return{attr:"phone_main"};if(!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(attrs.email))return{attr:"email"}}else if(this.unvalid(attrs.email)&&!this.unvalid(attrs.phone_main)){if(!/^\+[0-9]{12,12}$/i.test(attrs.phone_main))return{attr:"phone_main"}}else if(!this.unvalid(attrs.email)&&
this.unvalid(attrs.phone_main)){if(!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(attrs.email))return{attr:"email"}}else if(!this.unvalid(attrs.email)&&!this.unvalid(attrs.phone_main)){if(!/^\+[0-9]{12,12}$/i.test(attrs.phone_main))return{attr:"phone_main"};if(!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(attrs.email))return{attr:"email"}}},
unvalid:function(arg){return arg===undefined||arg===null},forInLength:function(arg){var j=0;for(var i in arg)j++;return j}});window.Invoices.CollectionInvoiceBuyers=Backbone.Collection.extend({model:window.Invoices.ModelInvoiceBuyer,initialize:function(){},syncArg:{"read":"data_buyers"}});window.Invoices.ModelInvoiceGoods=Backbone.Model.extend({defaults:{nid:0,gds_uid:null,title:null,price:"0.00",total:0,units:null,quantity:1},syncFilter:{"new":{there:["quantity","total","price","units","title","gr_id"]},"item":{there:["quantity","total","gds_uid"]}},idAttribute:"gds_uid",validate:function(attrs){if(attrs.units!==undefined&&!/^[a-zA-Z0-9\u0430-\u044f\u0410-\u042f\u0451\u0401\.,-_;:]{1,5}$/i.test(attrs.units||""))return{attr:"units"};if(attrs.price!==undefined&&!/^([0-9]+|[0-9]+\.[0-9]{0,2})$/i.test(attrs.price+
"")||attrs.price==0)return{attr:"price"};if(attrs.quantity!==undefined&&!/^[0-9]+$/i.test(attrs.quantity)||attrs.quantity==0)return{attr:"quantity"};if(attrs.title!==undefined&&!/^[\w\s\u0430-\u044f\u0410-\u042f\u0451\u0401]+$/i.test(attrs.title))return{attr:"title"}}});window.Invoices.CollectionInvoiceGoodss=Backbone.Collection.extend({model:window.Invoices.ModelInvoiceGoods,initialize:function(){},syncArg:{"read":"data_goods"}});window.Invoices.ModelInvoice=Backbone.Model.extend({defaults:{inv_uid:null,status:null,total:null,msg:"",descr:"",currency:"UAH",closed_at:null,created_at:null,expired_at:null,issued_at:null,paid_at:null,content:null,b_info:null,goods:null,buyers:null,_goods:null,_buyers:null,is_issued:0},idAttribute:"inv_uid",syncArg:{"create":"new_invoice","update":"new_invoice"},syncFilter:{"create":{there:["goods","buyers","total","currency","descr","msg","pref_system_id","created_at","expired_at","is_regular",
"is_issued"]},"update":{there:["goods","buyers","total","currency","descr","msg","pref_system_id","created_at","expired_at","is_regular","is_issued"]}},validate:function(attrs){if(attrs.goods&&attrs.goods.length<1)return{attr:"goods"};if(attrs.buyers&&attrs.buyers.length<1)return{attr:"buyers"}}});window.Invoices.CollectionInvoice=Backbone.Collection.extend({model:window.Invoices.ModelInvoice,initialize:function(){},syncArg:{"read":"data_invoice_ex"}});window.Invoices.ViewInvoice=Backbone.View.extend({initialize:function(opt){this.router=opt.router;this.collection=new window.Invoices.CollectionInvoice;this.collection.bind("add",this.eventAdd,this)},eventAdd:function(model){this.el.html(this.statsTemplate["invoice"].call(this,model.toJSON()));$("#invoicesInvoiceTabs",this.el).itabs({elTabs:$("#invoicesInvoiceTabs #invoicesItemInvoiceTabsList",this.el),selectorItem:"[data-id]"})},eventAddLoadre:function(){this.el.html(this.statsTemplate["invoiceLoader"].call(this))},
eventRemoveLoadre:function(){$('[data-sync="invoice"]',this.el).remove()},statsTemplate:{"invoice":_.template(window.Invoices.TEMPLATE["invoice.invoice"]),"invoiceLoader":_.template(window.Invoices.TEMPLATE["invoice.invoiceLoader"])},render:function(id,mod){var self=this;if(id)if(this.collection.get(id)){var model=this.collection.get(id);this.eventAdd.call(this,model);this.renderItem(model,id,mod)}else this.collection.fetch({data:{inv_uid:id},add:true,success:function(){var model=self.collection.get(id);
if(!model)self.router.navigate("invoice/edit/",true);else self.renderItem(model,id,mod)},error:function(collection,err){if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},loader:function(progress){if(progress==0)self.eventAddLoadre.call(self);else if(progress==1)self.eventRemoveLoadre.call(self)}});else{var model=this.collection.get("inv_uid",null);if(!model){model=new window.Invoices.ModelInvoice;this.collection.add(model)}else this.eventAdd.call(this,model);this.renderItem(model,id,mod)}return this},
renderItem:function(model,id,mod){if(!model.get("_buyers"))model.set({_buyers:new window.Invoices.CollectionInvoiceBuyers});var binfo=model.get("b_info");if(model.get("_buyers").length<1&&binfo&&binfo.length>0){binfo=JSON.parse(binfo)||[];if(!(binfo instanceof Array))binfo=[binfo];model.get("_buyers").add(binfo);model.set({b_info:null})}if(!model.get("_goods"))model.set({_goods:new window.Invoices.CollectionInvoiceGoodss});var content=model.get("content");if(model.get("_goods").length<1&&content&&
content.length>0){content=JSON.parse(content)||[];if(!(binfo instanceof Array))content=[content];model.get("_goods").add(content);model.set({content:null})}this.renderItemLoaded(model,id,mod);return this},renderItemLoaded:function(model,id,mod){var self=this;if(!mod)mod="edit";$("#invoicesInvoiceTabs",this.el).itabs("get","invoice/"+mod+"/"+(id?id+"/":""),function(el){var view;if(mod=="view"){$("#invoicesInvoiceTabs",this.el).itabs("select","invoice/view/"+(id?id+"/":""));view=new window.Invoices.ViewItemInvoiceView({el:$(el).undelegate(),
model:model,router:self.router})}else if(mod=="send"){$("#invoicesInvoiceTabs",this.el).itabs("select","invoice/send/"+(id?id+"/":""));view=new window.Invoices.ViewItemInvoiceSend({el:$(el).undelegate(),model:model,router:self.router})}else if(mod=="edit"){$("#invoicesInvoiceTabs",this.el).itabs("select","invoice/edit/"+(id?id+"/":""));view=new window.Invoices.ViewItemInvoiceEdit({el:$(el).undelegate(),model:model,router:self.router})}else if(mod=="print"){$("#invoicesInvoiceTabs",this.el).itabs("select",
"invoice/print/"+(id?id+"/":""));view=new window.Invoices.ViewItemInvoicePrint({el:$(el).undelegate(),model:model,router:self.router})}view.render()});return this}});window.Invoices.ViewItemInvoiceEdit=Backbone.View.extend({initialize:function(opt){this.router=opt.router;this.model.get("_buyers").unbind("add").bind("add",this.eventAddBuyer,this);this.model.get("_buyers").unbind("remove").bind("remove",this.eventRemoveBuyer,this);this.model.get("_goods").unbind("add").bind("add",this.eventAddGoods,this);this.model.get("_goods").unbind("remove").bind("remove",this.eventRemoveGoods,this);this.model.get("_goods").unbind("change").bind("change",this.eventChangeGoods,
this)},eventAddBuyer:function(model){$("#invoicesItemInvoiceItemBuyers",this.el).append(this.statsTemplate["itemInvoiceEditBuyerItem"].call(this,model.toJSON()))},eventRemoveBuyer:function(model){if(model.get("nid")>0)$('#invoicesItemInvoiceItemBuyers [data-nid="'+model.get("nid")+'"]',this.el).remove();else $('#invoicesItemInvoiceItemBuyers [data-id="'+model.get("b_uid")+'"]',this.el).remove()},eventAddGoods:function(model){model.set({total:parseFloat(model.get("price"))*parseInt(model.get("quantity"))},
{silent:true});var $c=$('#invoicesItemInvoiceItemGoods [data-state="new"]',this.el);if(model.get("nid")>0){$c.before($(this.statsTemplate["itemInvoiceEditNewGoodsItem"].call(this,model.toJSON())).iplaceholder());var $c1=$('#invoicesItemInvoiceItemGoods [data-nid="'+model.get("nid")+'"]',this.el);this.helperGoodsAtcmplt($('[name="title"]',$c1).get(0),$('[data-name="help"]',$c1).get(0))}else $c.before($(this.statsTemplate["itemInvoiceEditGoodsItem"].call(this,model.toJSON())).iplaceholder());this.eventAssumeInvoice.call(this)},
eventRemoveGoods:function(model){if(model.get("nid")>0)$('#invoicesItemInvoiceItemGoods [data-nid="'+model.get("nid")+'"]',this.el).remove();else $('#invoicesItemInvoiceItemGoods [data-id="'+model.get("gds_uid")+'"]',this.el).remove();this.eventAssumeInvoice.call(this)},eventChangeGoods:function(model){model.set({total:parseFloat(model.get("price"))*parseInt(model.get("quantity"))},{silent:true});var val=sprintf("%01.2f",model.get("total"));if(model.get("nid")>0)$('#invoicesItemInvoiceItemGoods [data-nid="'+
model.get("nid")+'"] [data-name="total"]',this.el).html(val);else $('#invoicesItemInvoiceItemGoods [data-id="'+model.get("gds_uid")+'"] [data-name="total"]',this.el).html(val);this.eventAssumeInvoice.call(this)},eventNewGoods:function(model){$("#invoicesItemInvoiceItemGoods",this.el).append($(this.statsTemplate["itemInvoiceEditGoodsNew"].call(this)).iplaceholder());var $c=$('#invoicesItemInvoiceItemGoods [data-state="new"]',this.el);this.helperGoodsAtcmplt($('[name="title"]',$c).get(0),$('[data-name="help"]',
$c).get(0))},eventAddHelpBuyer:function(model){$("#invoicesItemInvoiceBuyersHelp",this.el).append(this.statsTemplate["itemInvoiceEditBuyerHelpItem"].call(this,model.toJSON()))},eventAddHelpGroupBuyer:function(model){$("#invoicesItemInvoiceBuyersHelp",this.el).append(this.statsTemplate["itemInvoiceEditBuyerHelpGroup"].call(this,model.toJSON()))},eventAddHelpGoods:function(model,el){$(el,this.el).append(this.statsTemplate["itemInvoiceEditGoodsHelpItem"].call(this,model.toJSON()))},eventAddHelpGroupGoods:function(model,
el){$(el,this.el).append(this.statsTemplate["itemInvoiceEditGoodsHelpGroup"].call(this,model.toJSON()))},eventAddLoaderBuyersGroup:function(arg){$("#invoicesInvoiceBuyersGroupLoader",this.el).html(this.statsTemplate["itemInvoiceEditLoaderBuyersGroup"].call(this,arg))},eventRemoveLoaderBuyersGroup:function(arg){$("#invoicesInvoiceBuyersGroupLoader",this.el).empty()},eventAddLoaderAtcmplt:function(arg){$(arg).html(this.statsTemplate["itemInvoiceEditLoaderAtcmplt"].call(this))},eventRemoveLoaderAtcmplt:function(arg){$(arg).empty()},
eventAddEmpty:function(arg){$(arg).html(this.statsTemplate["itemInvoiceEditAtcmpltEmpty"].call(this))},eventAddLoaderGoodsGroup:function(arg){var el=$('#invoicesItemInvoiceItemGoods [data-nid="'+arg.id+'"]',this.el).get(0);if($(el).size()>0)$(el).hide().after($(this.statsTemplate["itemInvoiceEditLoaderGoodsGroup"].call(this,arg)).attr("data-lid",$(el).attr("data-nid")));else $('#invoicesItemInvoiceItemGoods [data-state="new"]',this.el).before($(this.statsTemplate["itemInvoiceEditLoaderGoodsGroup"].call(this,
arg)).attr("data-lid",0))},eventRemoveLoaderGoodsGroup:function(arg){arg.id=arg.id||0;$('#invoicesItemInvoiceItemGoods [data-lid="'+arg.id+'"]',this.el).remove()},eventAssumeInvoice:function(){var total=0;this.model.get("_goods").each(function(model){total+=model.get("total")});this.model.set({total:total});$("#invoicesInvoiceGoodsTotal",this.el).html(sprintf("%01.2f",total))},eventAddLoaderDialog:function(){$("#invoicesItemInvoiceEditDialog-"+(this.model.get("inv_uid")||0)).addClass("creating").append(this.statsTemplate["itemInvoiceEditDialogLoader"].call(this))},
eventRemoveLoaderDialog:function(){$("#invoicesItemInvoiceEditDialog-"+(this.model.get("inv_uid")||0)+' [data-sync="buyers"]').remove();$("#invoicesItemInvoiceEditDialog-"+(this.model.get("inv_uid")||0)).removeClass("creating")},statsTemplate:{"itemInvoiceEdit":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceEdit"]),"itemInvoiceEditBuyerItem":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceEditBuyerItem"]),"itemInvoiceEditGoodsItem":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceEditGoodsItem"]),
"itemInvoiceEditGoodsNew":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceEditGoodsNew"]),"itemInvoiceEditNewGoodsItem":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceEditNewGoodsItem"]),"itemInvoiceEditBuyerHelpGroup":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceEditBuyerHelpGroup"]),"itemInvoiceEditBuyerHelpItem":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceEditBuyerHelpItem"]),"itemInvoiceEditGoodsHelpGroup":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceEditGoodsHelpGroup"]),
"itemInvoiceEditGoodsHelpItem":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceEditGoodsHelpItem"]),"itemInvoiceEditDialog":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceEditDialog"]),"itemInvoiceEditLoaderBuyersGroup":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceEditLoaderBuyersGroup"]),"itemInvoiceEditLoaderGoodsGroup":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceEditLoaderGoodsGroup"]),"itemInvoiceEditLoaderAtcmplt":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceEditLoaderAtcmplt"]),
"itemInvoiceEditAtcmpltEmpty":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceEditAtcmpltEmpty"]),"itemInvoiceEditDialogLoader":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceEditDialogLoader"])},render:function(){this.el.html($(this.statsTemplate["itemInvoiceEdit"].call(this,this.model.toJSON())).iplaceholder());this.eventNewGoods();this.model.get("_buyers").each(function(model){model.collection.trigger("add",model)});this.model.get("_goods").each(function(model){model.collection.trigger("add",
model)});this.helperBuyerAtcmplt();var $c=$('#invoicesItemInvoiceItemGoods [data-state="new"]',this.el);this.helperGoodsAtcmplt($('[name="title"]',$c).get(0),$('[data-name="help"]',$c).get(0));this.helperDialogNewBuyer();return this},events:{'change #invoicesItemInvoiceItemGoods [data-state="new"] [name="title"]':"eventDOMNewGoods",'change #invoicesItemInvoiceItemGoods [data-state="new"] [name="price"]':"eventDOMNewGoods",'change #invoicesItemInvoiceItemGoods [data-state="new"] [name="quantity"]':"eventDOMNewGoods",
'change #invoicesItemInvoiceItemGoods [data-state="new"] [name="units"]':"eventDOMNewGoods",'click #invoicesItemInvoiceItemGoods [data-name="remove"]':"eventDOMRemoveGoods",'change #invoicesItemInvoiceItemGoods [name="price"]':"eventDOMChangeGoods",'change #invoicesItemInvoiceItemGoods [name="quantity"]':"eventDOMChangeGoods",'change #invoicesItemInvoiceItemGoods [name="units"]':"eventDOMChangeGoods",'change #invoicesItemInvoiceItemGoods [name="title"]':"eventDOMChangeGoods",'click #invoicesItemInvoiceItemBuyers [data-name="remove"]':"eventDOMRemoveBuyer",
'click [data-name="addbuyer"]':"eventDOMOpenDialog",'change [name="descr"]':"eventDOMChangeInvoice",'change [name="msg"]':"eventDOMChangeInvoice",'click [data-name="created"]':"eventDOMSaveCreated",'click [data-name="issued"]':"eventDOMSaveIssued",'click [data-name="view"]':"eventDOMToView","click #invoicesItemInvoiceAddSwitch":"eventSwitchAdd"},eventSwitchAdd:function(e){if(e.target.sw){e.target.sw=false;$('[data-style="add"]',this.el).hide()}else{e.target.sw=true;$('[data-style="add"]',this.el).show()}},
eventDOMSaveCreated:function(e){this.model.set({is_issued:0,save:true});this.helperSaveInvoice.call(this)},eventDOMSaveIssued:function(e){this.model.set({is_issued:1,save:true});this.helperSaveInvoice.call(this)},eventDOMToView:function(e){var self=this;var arg=this.helperGetItems();var res=this.model.set({buyers:arg.buyers,goods:arg.goods},{error:function(model,err){if(err.attr=="buyers")$("#invoicesItemInvoiceBuyersFind",self.el).ierror({wrap:true,msg:self.helperGetError.call(self,model,err)});
else if(err.attr=="goods")$('#invoicesItemInvoiceItemGoods  [data-state] [name="title"]',self.el).ierror({wrap:true,msg:self.helperGetError.call(self,model,err)})}});if(res){var id=this.model.get("inv_uid");this.router.navigate("invoice/view/"+(id?id+"/":""),true)}},helperGetItems:function(){var buyers=[],goods=[];this.model.get("_buyers").each(function(model){if(model.get("nid")>0)buyers.push(model.toJSONExt(model.syncFilter["new"]));else buyers.push(model.toJSONExt(model.syncFilter["item"]))});
this.model.get("_goods").each(function(model){if(model.get("nid")>0)goods.push(model.toJSONExt(model.syncFilter["new"]));else goods.push(model.toJSONExt(model.syncFilter["item"]))});return{buyers:buyers,goods:goods}},helperSaveInvoice:function(){var self=this;var arg=this.helperGetItems();var res=this.model.set({buyers:arg.buyers,goods:arg.goods},{error:function(model,err){if(err.attr=="buyers")$("#invoicesItemInvoiceBuyersFind",self.el).ierror({wrap:true,msg:self.helperGetError.call(self,model,err)});
else if(err.attr=="goods")$('#invoicesItemInvoiceItemGoods  [data-state] [name="title"]',self.el).ierror({wrap:true,msg:self.helperGetError.call(self,model,err)})}});if(res){var id=this.model.get("inv_uid");this.router.navigate("invoice/send/"+(id?id+"/":""),true)}},eventDOMOpenDialog:function(e,value){var $dialog=$("#invoicesItemInvoiceEditDialog-"+(this.model.get("inv_uid")||0));if(value)$('[name="name"]',$dialog).val(value);$dialog.dialog("open")},eventDOMNewGoods:function(e){var data={},self=
this,$c=$('#invoicesItemInvoiceItemGoods [data-state="new"]',this.el);$("input",$c).each(function(){data[$(this).attr("name")]=$(this).val()});data["quantity"]=data["quantity"]||1;data["price"]=data["price"]||0;data["units"]=data["units"]||"pcs.";data["nid"]=_.uniqueId();var model=new window.Invoices.ModelInvoiceGoods;var res=model.set(data,{error:function(model,err){$('input[name="'+err.attr+'"]',$c).ierror({wrap:true,msg:self.helperGetError.call(self,model,err)})}});if(res){var res0=false;this.model.get("_goods").add(model,
{expUnique:"title",error:function(model,err){res0=true;$('[name="title"]',$c).ierror({wrap:true,msg:"This goods has been selected 1"})}});if(!res0){$c.remove();this.eventNewGoods.call(this);$('#invoicesItemInvoiceItemGoods [data-state="new"] [name="title"]',this.el).focus()}}},eventDOMRemoveGoods:function(e){this.helperDOMRemoveGoods(e.target)},eventDOMRemoveBuyer:function(e){var id=$(e.target).attr("data-id"),nid=$(e.target).attr("data-nid"),model;if(id>0)model=this.model.get("_buyers").get(id);
else if(nid>0)model=this.model.get("_buyers").get("nid",nid);if(model)this.model.get("_buyers").remove(model)},eventDOMChangeGoods:function(e){var id=$(e.target).attr("data-id"),nid=$(e.target).attr("data-nid"),model;if(id>0)model=this.model.get("_goods").get("gds_uid",id);else if(nid>0)model=this.model.get("_goods").get("nid",nid);if(model)this.helperDOMChangeGoods(model,e.target)},eventDOMChangeInvoice:function(e){var data={};data[$(e.target).attr("name")]=$(e.target).val();this.model.set(data,
{silent:true})},helperDOMRemoveGoods:function(el){var id=$(el).attr("data-id"),nid=$(el).attr("data-nid"),model;if(id>0)model=this.model.get("_goods").get(id);else if(nid>0)model=this.model.get("_goods").get("nid",nid);if(model)this.model.get("_goods").remove(model)},helperDOMChangeGoods:function(model,el){var name=$(el).attr("name"),data={},self=this;data[name]=$(el).val();model.set(data,{error:function(model,err){$(el).ierror({wrap:true,msg:self.helperGetError.call(self,model,err)})}})},helperBuyerAtcmplt:function(){var collectionBuyers,
load=false,self=this,helpBuyer=this.router.collection.get("invoiceHelpBuyer").get("view");$("#invoicesItemInvoiceBuyersFind",this.el).iautocomplete({el:$("#invoicesItemInvoiceBuyersHelp",this.el).get(0),selectorItem:"[data-id]",validate:function(value){if(!/^[0-9a-zA-Z\u0430-\u044f\u0410-\u042f\u0451\u0401\s]+$/i.test(value))return false;return true},render:function(opt,value){collectionBuyers=helpBuyer.render(value,function(progress){if(progress==0){load=true;self.eventAddLoaderAtcmplt(opt.el)}else if(progress==
1){load=false;self.eventRemoveLoaderAtcmplt(opt.el)}});if(load){$(opt.el).show();return}$(opt.el).empty().show();if(collectionBuyers.groups&&typeof collectionBuyers.groups.each=="function")collectionBuyers.groups.each(self.eventAddHelpGroupBuyer,self);if(collectionBuyers.items&&typeof collectionBuyers.items.each=="function")collectionBuyers.items.each(self.eventAddHelpBuyer,self)},renderEmpty:function(opt,value){self.eventAddEmpty.call(self,opt.el)},selected:function(opt,value,item){var role=$(item).attr("data-role");
if(role=="buyer"){if(collectionBuyers.items)self.model.get("_buyers").add(collectionBuyers.items.get("b_uid",$(item).attr("data-id")).toJSON(),{expUnique:"b_uid",error:function(model,err){}})}else if(role=="group"){var id=$(item).attr("data-id"),group;if(collectionBuyers.groups){model=collectionBuyers.groups.get(id);if(model)group=model.get("title")}self.model.get("_buyers").fetch({data:{gr_id:id},add:true,expUnique:"b_uid",error:function(collection,err){},loader:function(progress){if(progress==0)self.eventAddLoaderBuyersGroup({group:group});
else if(progress==1)self.eventRemoveLoaderBuyersGroup()}})}$(this).val("").focus()},hided:function(opt){if(load)$(opt.el).hide();else $(opt.el).empty().hide()},entered:function(el,opt){self.eventDOMOpenDialog(null,$(this).val())}});helpBuyer.eventEndedRequest=function(key){$("#invoicesItemInvoiceBuyersFind",self.el).iautocomplete("render")}},helperGoodsAtcmplt:function(el,elHelp){var collectionGoodss,self=this,load=false,helpGoods=this.router.collection.get("invoiceHelpGoods").get("view");$(el,this.el).iautocomplete({el:$(elHelp,
this.el).get(0),selectorItem:"[data-id]",validate:function(value){if(!/^[0-9a-zA-Z\u0430-\u044f\u0410-\u042f\u0451\u0401\s]+$/i.test(value))return false;return true},render:function(opt,value){collectionGoodss=helpGoods.render(value,function(progress){if(progress==0){load=true;self.eventAddLoaderAtcmplt(opt.el)}else if(progress==1){load=false;self.eventRemoveLoaderAtcmplt(opt.el)}});if(load){$(opt.el).show();return}$(opt.el).empty().show();if(collectionGoodss.groups&&typeof collectionGoodss.groups.each==
"function")collectionGoodss.groups.each(function(model){self.eventAddHelpGroupGoods.call(self,model,elHelp)},self);if(collectionGoodss.items&&typeof collectionGoodss.items.each=="function")collectionGoodss.items.each(function(model){self.eventAddHelpGoods.call(self,model,elHelp)},self)},selected:function(opt,value,item){var role=$(item).attr("data-role"),self1=this;if(role=="goods"){if(collectionGoodss.items)if($(this).attr("data-nid")){var model=self.model.get("_goods").get("nid",$(this).attr("data-nid"));
var helpModel=collectionGoodss.items.get("gds_uid",$(item).attr("data-id"));if(!self.model.get("_goods").get(helpModel.get("gds_uid"))){model.collection.add(helpModel.toJSON());model.collection.remove(model)}else $(self1).ierror({wrap:true,msg:"This goods has been selected"})}else{var res=false;self.model.get("_goods").add(collectionGoodss.items.get($(item).attr("data-id")).toJSON(),{expUnique:"gds_uid",error:function(model,err){if(err.errno=="add"){res=true;$(self1).ierror({wrap:true,msg:"This goods has been selected"})}}});
if(!res)$(this).val("").focus()}}else if(role=="group"){var id=$(item).attr("data-id"),group;if(collectionGoodss.groups){model=collectionGoodss.groups.get(id);if(model)group=model.get("title")}self.model.get("_goods").fetch({data:{gr_id:$(item).attr("data-id")},add:true,expUnique:"gds_uid",error:function(collection,err){},success:function(collection){self.helperDOMRemoveGoods(self1)},loader:function(progress){var id=$(self1).attr("data-nid");if(progress==0)self.eventAddLoaderGoodsGroup.call(self,
{id:id,group:group});else if(progress==1)self.eventRemoveLoaderGoodsGroup.call(self,{id:id,group:group})}});$(this).val("").focus()}},hided:function(opt){if(load)$(elHelp,self.el).hide();else $(elHelp,self.el).empty().hide()},entered:function(el,opt){$(this).trigger("change")}});helpGoods.eventEndedRequest=function(key){$('#invoicesItemInvoiceItemGoods [name="title"]',self.el).iautocomplete("render")}},helperDialogNewBuyer:function(){this.el.append(this.statsTemplate["itemInvoiceEditDialog"].call(this,
{id:this.model.get("inv_uid")}));var self=this;$("#invoicesItemInvoiceEditDialog-"+(this.model.get("inv_uid")||0),this.el).iplaceholder().dialog({autoOpen:false,resizable:false,modal:true,draggable:false,buttons:{Create:function(){var dialog=this,data={};$('input[type="text"], textarea',dialog).each(function(){data[$(this).attr("name")]=$(this).val()||null});data["gr_id"]=1;self.model.get("_buyers").create(data,{error:function(model,err){if(err.attr)$('input[name="'+err.attr+'"]',dialog).ierror({wrap:true,
msg:self.helperGetError.call(self,model,err)});if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},success:function(model,res){$('input[type="text"], textarea',dialog).val("");$(dialog).dialog("close");$("#invoicesItemInvoiceBuyersFind",self.el).val("").focus()},loader:function(progress){if(progress==0)self.eventAddLoaderDialog.call(self);else if(progress==1)self.eventRemoveLoaderDialog.call(self)}})},Cancel:function(){$(this).dialog("close")}}})},helperGetError:function(model,err){switch(err.attr){case "name":return"Buyer name - incorrect";
case "email":return"Buyer email - incorrect";case "phone_main":return"Buyer phone - incorrect";case "units":return"Buyer units - incorrect";case "price":return"Buyer price - incorrect";case "quantity":return"Buyer quantity - incorrect";case "title":return"Buyer title - incorrect";case "buyers":return"You did not enter a single buyer";case "goods":return"You did not enter a single goods"}}});window.Invoices.ViewItemInvoiceView=Backbone.View.extend({initialize:function(opt){this.router=opt.router},eventAddLoader:function(){$("#invoicesItemInvoiceViews",this.el).append(this.statsTemplate["itemInvoiceViewLoader"].call(this))},eventRemoveLoader:function(){$('#invoicesItemInvoiceViews [data-sync="invoiceView"]',this.el).remove()},eventAddInvoice:function(data){$("#invoicesItemInvoiceViews",this.el).append(this.statsTemplate["itemInvoiceViewBuyers"].call(this,data))},statsTemplate:{"itemInvoiceView":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceView"]),
"itemInvoiceViewBuyers":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceViewBuyers"]),"itemInvoiceViewLoader":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceViewLoader"]),"itemInvoiceViewDialog":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceViewDialog"])},render:function(){var self=this;this.el.html(this.statsTemplate["itemInvoiceView"].call(this,this.model.toJSON()));var opts={success:function(model){var mmerchant=model;self.model.get("_buyers").each(function(model){self.eventAddInvoice.call(self,
{buyer:model.toJSON(),goods:self.model.get("_goods").toJSON(),merchant:mmerchant.toJSON(),invoice:self.model.toJSON()})})},error:function(model,err){if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},loader:function(progress){if(progress==0)self.eventAddLoader.call(self);else self.eventRemoveLoader.call(self)}};if(!this.router.collection.get("merchant")){this.router.helperRenderMerchant.call(this.router);this.router.collection.get("merchant").get("view").render(opts)}else this.router.collection.get("merchant").get("view").render(opts);
this.helperDialogError.call(this);return this},events:{'click [data-name="created"]':"eventDOMSaveCreated",'click [data-name="issued"]':"eventDOMSaveIssued"},eventDOMSaveCreated:function(e){this.model.set({is_issued:0,save:true});this.helperSaveInvoice.call(this)},eventDOMSaveIssued:function(e){this.model.set({is_issued:1,save:true});this.helperSaveInvoice.call(this)},helperSaveInvoice:function(){var self=this,buyers=[],goods=[];this.model.get("_buyers").each(function(model){if(model.get("nid")>0)buyers.push(model.toJSONExt(model.syncFilter["new"]));
else buyers.push(model.toJSONExt(model.syncFilter["item"]))});this.model.get("_goods").each(function(model){if(model.get("nid")>0)goods.push(model.toJSONExt(model.syncFilter["new"]));else goods.push(model.toJSONExt(model.syncFilter["item"]))});var res=this.model.set({buyers:buyers,goods:goods},{error:function(model,err){var id=model.get("inv_uid");if(err.attr=="buyers"){$('#invoicesItemInvoiceViewDialog [data-id="error"]').html("You did not enter a single buyer");$("#invoicesItemInvoiceViewDialog").dialog("open")}else if(err.attr==
"goods"){$('#invoicesItemInvoiceViewDialog [data-id="error"]').html("You did not enter a single goods");$("#invoicesItemInvoiceViewDialog").dialog("open")}}});if(res){var id=this.model.get("inv_uid");this.router.navigate("invoice/send/"+(id?id+"/":""),true)}},helperDialogError:function(){$(this.el).append(this.statsTemplate["itemInvoiceViewDialog"].call(this));$("#invoicesItemInvoiceViewDialog",this.el).dialog({autoOpen:false,resizable:false,modal:true,draggable:false,buttons:[{text:"Ok",click:function(){$(this).dialog("close")}}]})}});window.Invoices.ViewItemInvoiceSend=Backbone.View.extend({initialize:function(opt){this.router=opt.router},eventAddError:function(data){$("#invoicesItemInvoiceSendBody",this.el).append(this.statsTemplate["itemInvoiceSendError"].call(this,{msg:data,id:this.model.get("inv_uid")}))},eventAddSuccess:function(data){$("#invoicesItemInvoiceSendBody",this.el).append(this.statsTemplate["itemInvoiceSendSuccess"].call(this,data))},eventAddLoader:function(){$("#invoicesItemInvoiceSendBody",this.el).html(this.statsTemplate["itemInvoiceSendLoader"].call(this))},
eventRemoveLoader:function(){$('#invoicesItemInvoiceSendBody [data-sync="invoice"]',this.el).remove()},statsTemplate:{"itemInvoiceSend":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceSend"]),"itemInvoiceSendLoader":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceSendLoader"]),"itemInvoiceSendSuccess":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceSendSuccess"]),"itemInvoiceSendError":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoiceSendError"])},render:function(){var self=
this;this.el.html(this.statsTemplate["itemInvoiceSend"].call(this));if(this.model.get("save")){if(this.model.get("saving"))return;this.model.set({saving:true},{silent:true});this.model.save(null,{error:function(model,err){if(err.error==1||err.msg)$.ierrorDialog("add",err.msg);model.unset("save",{silent:true});model.unset("saving",{silent:true})},success:function(model,res){res=res||{};if(res["ok"])_.each(res["ok"]["invoice"],self.eventAddSuccess,self);else if(res["errors"])_.each(res["errors"],self.eventAddError,
self);else console.error('"ok" & "errors" is not defined');model.unset("save",{silent:true});model.unset("saving",{silent:true})},loader:function(progress){if(progress==0)self.eventAddLoader.call(self);else self.eventRemoveLoader.call(self)}})}return this}});window.Invoices.ViewItemInvoicePrint=Backbone.View.extend({initialize:function(opt){this.router=opt.router},eventAddLoader:function(){$("#invoicesItemInvoicePrint",this.el).append(this.statsTemplate["itemInvoicePrintLoader"].call(this))},eventRemoveLoader:function(){$('#invoicesItemInvoicePrint [data-sync="invoiceView"]',this.el).remove()},eventAddInvoice:function(data){$("#invoicesItemInvoicePrint",this.el).append(this.statsTemplate["itemInvoicePrintInvoice"].call(this,data))},statsTemplate:{"itemInvoicePrint":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoicePrint"]),
"itemInvoicePrintInvoice":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoicePrintInvoice"]),"itemInvoicePrintLoader":_.template(window.Invoices.TEMPLATE["itemInvoice.itemInvoicePrintLoader"])},render:function(){var self=this;this.el.html(this.statsTemplate["itemInvoicePrint"].call(this,this.model.toJSON()));var opts={success:function(model){var mmerchant=model;self.model.get("_buyers").each(function(model){self.eventAddInvoice.call(self,{buyer:model.toJSON(),goods:self.model.get("_goods").toJSON(),
merchant:mmerchant.toJSON(),invoice:self.model.toJSON()})})},error:function(model,err){if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},loader:function(progress){if(progress==0)self.eventAddLoader.call(self);else self.eventRemoveLoader.call(self)}};if(!this.router.collection.get("merchant")){this.router.helperRenderMerchant.call(this.router);this.router.collection.get("merchant").get("view").render(opts)}else this.router.collection.get("merchant").get("view").render(opts);return this},events:{}});window.Invoices.ModelItemInvoiceHelpItem=Backbone.Model.extend({defaults:{id:0,selection:null,status:"unloaded"},idAttribute:"id"});window.Invoices.CollectionItemInvoiceHelpItem=Backbone.Collection.extend({model:window.Invoices.ModelItemInvoiceHelpItem,initialize:function(){},getExp:function(arg){var m=null;this.each(function(model){var exp=new RegExp(model.id,"i");if(exp.test(arg)){m=model;return false}});return m}});window.Invoices.ModelItemInvoiceHelpGroupBuyer=Backbone.Model.extend({defaults:{gr_id:0,title:"",count:0},idAttribute:"gr_id"});window.Invoices.CollectionItemInvoiceHelpGroupBuyer=Backbone.Collection.extend({model:window.Invoices.ModelItemInvoiceHelpGroupBuyer,initialize:function(opt){},syncArg:{read:"data_group_brs"},findExp:function(arg){var res=new window.Invoices.CollectionItemInvoiceHelpGroupBuyer;var exp=new RegExp(arg,"i");this.each(function(model){if(exp.test(model.get("title")))res.add(model)});return res}});window.Invoices.ModelItemInvoiceHelpGroupGoods=Backbone.Model.extend({defaults:{gr_id:0,title:"",count:0},idAttribute:"gr_id"});window.Invoices.CollectionItemInvoiceHelpGroupGoods=Backbone.Collection.extend({model:window.Invoices.ModelItemInvoiceHelpGroupGoods,initialize:function(opt){},syncArg:{read:"data_group_gds"},findExp:function(arg){var res=new window.Invoices.CollectionItemInvoiceHelpGroupGoods;var exp=new RegExp(arg,"i");this.each(function(model){if(exp.test(model.get("title")))res.add(model)});return res}});window.Invoices.ModelItemInvoiceHelpSelectionGoods=Backbone.Model.extend({defaults:{gds_uid:null,title:"",price:"0.00",units:"",img_url:null,desc_url:null},idAttribute:"gds_uid",validate:function(attrs){if(attrs.title!==undefined&&!/^[\w\s\u0430-\u044f\u0410-\u042f\u0451\u0401]+$/i.test(attrs.title))return{attr:"title"};if(attrs.units!==undefined&&!/^[a-zA-Z0-9\u0430-\u044f\u0410-\u042f\u0451\u0401\.,-_;:]{1,5}$/i.test(attrs.units||""))return{attr:"units"};if(attrs.price!==undefined&&!/^([0-9]+|[0-9]+\.[0-9]{0,2})$/i.test(attrs.price+
"")||attrs.price==0)return{attr:"price"}}});window.Invoices.CollectionItemInvoiceHelpSelectionGoods=Backbone.Collection.extend({model:window.Invoices.ModelItemInvoiceHelpSelectionGoods,initialize:function(opt){},syncArg:{read:"find_goods"},findExp:function(arg){var res=new window.Invoices.CollectionItemInvoiceHelpSelectionGoods;var exp=new RegExp(arg,"i");this.each(function(model){if(exp.test(model.get("title")))res.add(model)});return res}});window.Invoices.ModelItemInvoiceHelpSelectionBuyer=Backbone.Model.extend({defaults:{b_uid:0,name:null,img_url:"",phone_main:null,email:null,comment:null},idAttribute:"b_uid",validate:function(attrs){if(attrs.name!==undefined)if(!/^[\w\s\u0430-\u044f\u0410-\u042f\u0451\u0401\.,\(\)]+$/i.test(attrs.name||""))return{attr:"name"};if(this.unvalid(attrs.email)&&this.unvalid(attrs.phone_main))if(this.forInLength(attrs)===1&&attrs["b_uid"]>0||attrs["error"]==0);else{if(!/^\+[0-9]{12,12}$/i.test(attrs.phone_main))return{attr:"phone_main"};
if(!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(attrs.email))return{attr:"email"}}else if(this.unvalid(attrs.email)&&!this.unvalid(attrs.phone_main)){if(!/^\+[0-9]{12,12}$/i.test(attrs.phone_main))return{attr:"phone_main"}}else if(!this.unvalid(attrs.email)&&this.unvalid(attrs.phone_main)){if(!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(attrs.email))return{attr:"email"}}else if(!this.unvalid(attrs.email)&&
!this.unvalid(attrs.phone_main)){if(!/^\+[0-9]{12,12}$/i.test(attrs.phone_main))return{attr:"phone_main"};if(!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(attrs.email))return{attr:"email"}}},unvalid:function(arg){return arg===undefined||arg===null},forInLength:function(arg){var j=0;for(var i in arg)j++;return j}});window.Invoices.CollectionItemInvoiceHelpSelectionBuyer=Backbone.Collection.extend({model:window.Invoices.ModelItemInvoiceHelpSelectionBuyer,initialize:function(opt){},syncArg:{read:"find_buyers"},findExp:function(arg){var res=new window.Invoices.CollectionItemInvoiceHelpSelectionBuyer;var exp=new RegExp(arg,"i");this.each(function(model){if(exp.test(model.get("name"))||exp.test(model.get("email"))||exp.test(model.get("phone_main")))res.add(model)});return res}});window.Invoices.ViewItemInvoiceHelpBuyer=Backbone.View.extend({initialize:function(opt){this.router=opt.router;this.collectionGroups=new window.Invoices.CollectionItemInvoiceHelpGroupBuyer;this.collectionItems=new window.Invoices.CollectionItemInvoiceHelpItem},eventEndedRequest:undefined,render:function(key,loader){var lg=false,li=false,lsi=false;var data={groups:null,items:null},self=this;if(this.collectionGroups.length<1&&!this.collectionGroups.load){this.collectionGroups.fetch({error:function(model,
err){if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},success:function(){self.helperLSG=true;if(lsi&&typeof self.eventEndedRequest=="function")self.eventEndedRequest.call(self,key)},loader:function(progress){if(progress==0){lg=true;if(!li&&typeof loader=="function")loader.call(self,progress)}else if(progress==1){lg=false;if(!li&&typeof loader=="function")loader.call(self,progress)}}});this.collectionGroups.load=true}else data.groups=this.collectionGroups.findExp(key);var sel=this.collectionItems.getExp(key);
if(sel)if(sel.get("status")=="loaded")data.items=sel.get("selection").findExp(key);else if(sel.get("status")=="unloaded");else{if(sel.get("status")=="load");}else{this.collectionItems.add({id:key,selection:new window.Invoices.CollectionItemInvoiceHelpSelectionBuyer});var model=this.collectionItems.get(key);model.get("selection").fetch({data:{all:key},error:function(model,err){if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},success:function(collection){model.set({status:"loaded"});lsi=true;
if(self.helperLSG&&typeof self.eventEndedRequest=="function")self.eventEndedRequest.call(self,key)},loader:function(progress){if(progress==0){li=true;if(!lg&&typeof loader=="function")loader.call(self,progress)}else if(progress==1){li=false;if(!lg&&typeof loader=="function")loader.call(self,progress)}}});model.set({status:"load"})}return data},helperLSG:false});window.Invoices.ViewItemInvoiceHelpGoods=Backbone.View.extend({initialize:function(opt){this.router=opt.router;this.collectionGroups=new window.Invoices.CollectionItemInvoiceHelpGroupGoods;this.collectionItems=new window.Invoices.CollectionItemInvoiceHelpItem},eventEndedRequest:undefined,render:function(key,loader){var lg=false,li=false,lsg=false,lsi=false;var data={groups:null,items:null},self=this;if(this.collectionGroups.length<1&&!this.collectionGroups.load){this.collectionGroups.fetch({error:function(model,
err){if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},success:function(){self.helperLSG=true;if(lsi&&typeof self.eventEndedRequest=="function")self.eventEndedRequest.call(self,key)},loader:function(progress){if(progress==0){lg=true;if(!li&&typeof loader=="function")loader.call(self,progress)}else if(progress==1){lg=false;if(!li&&typeof loader=="function")loader.call(self,progress)}}});this.collectionGroups.load=true}else data.groups=this.collectionGroups.findExp(key);var sel=this.collectionItems.getExp(key);
if(sel)if(sel.get("status")=="loaded")data.items=sel.get("selection").findExp(key);else if(sel.get("status")=="unloaded");else{if(sel.get("status")=="load");}else{this.collectionItems.add({id:key,selection:new window.Invoices.CollectionItemInvoiceHelpSelectionGoods});var model=this.collectionItems.get(key);model.get("selection").fetch({data:{name:key},error:function(model,err){if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},success:function(collection){model.set({status:"loaded"});lsi=true;
if(self.helperLSG&&typeof self.eventEndedRequest=="function")self.eventEndedRequest.call(self,key)},loader:function(progress){if(progress==0){li=true;if(!lg&&typeof loader=="function")loader.call(self,progress)}else if(progress==1){li=false;if(!lg&&typeof loader=="function")loader.call(self,progress)}}});model.set({status:"load"})}return data},helperLSG:false});window.Invoices.ModelMerchant=Backbone.Model.extend({defaults:{title:null,phone:null,email:null,addr:null,logo_url:null,currency:"UAH",is_vat_payer:0,to_notify:0,to_sms:1,descr:null,pref_payment_id:null,card:null,mfo:null,okpo:null},syncArg:{"read":"all_data_inv","update":"set_merch_edit","create":"set_merch_edit"},syncFilter:{"update":{there:["email","logo_url","pref_payment_id","to_sms","to_notify","is_vat_payer","descr","addr","currency","card","title"]},"create":{there:["email","logo_url","pref_payment_id",
"to_sms","to_notify","is_vat_payer","descr","addr","currency","card","title"]}},validate:function(attrs){if(attrs.title!==undefined&&!/^[\w\s\u0430-\u044f\u0410-\u042f\u0451\u0401]+$/i.test(attrs.title))return{attr:"title"};if(attrs.email!==undefined&&!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(attrs.email))return{attr:"email"};if(attrs.is_vat_payer!==undefined&&!/^(0|1)$/i.test(attrs.is_vat_payer))return{attr:"is_vat_payer"};
if(attrs.to_notify!==undefined&&!/^(0|1)$/i.test(attrs.to_notify))return{attr:"to_notify"};if(attrs.notivy_via!==undefined&&!/^(sms|email)$/i.test(attrs.notivy_via))return{attr:"notivy_via"};if(attrs.pref_payment_id!==undefined&&!/^[0-9]+$/i.test(attrs.pref_payment_id))return{attr:"pref_payment_id"};if(attrs.card!==undefined&&!/^[0-9]{16}$/i.test(attrs.card))return{attr:"card"};if(attrs.logo_url&&!/^(([\w]+:)?\/\/)?(([\d\w]|%[a-fA-f\d]{2,2})+(:([\d\w]|%[a-fA-f\d]{2,2})+)?@)?([\d\w][-\d\w]{0,253}[\d\w]\.)+[\w]{2,4}(:[\d]+)?(\/([-+_~.\d\w]|%[a-fA-f\d]{2,2})*)*(\?(&?([-+_~.\d\w]|%[a-fA-f\d]{2,2})=?)*)?$/.test(attrs.logo_url))return{attr:"logo_url"}},
validateCard:function(card){var sum=0;for(var i=0;i<card.length;i++){var p=parseInt(card[i]);if(i%2==0){p*=2;if(p>9)p-=9}sum+=p}if(sum%10!=0)return false;return true}});window.Invoices.ViewMerchant=Backbone.View.extend({initialize:function(opt){this.router=opt.router;this.model=new window.Invoices.ModelMerchant},eventChange:function(model){var jsonModel=model.toJSON();this.el.prepend($(this.statsTemplate["merchant"].call(this,jsonModel)).iplaceholder());$('#invoicesMerchantDialogLogo [name="logo_url"]').val(jsonModel["logo_url"]||"")},eventAddLoader:function(){this.el.append(this.statsTemplate["merchantLoader"].call(this))},eventRemoveLoader:function(){$('[data-sync="merchant"]',
this.el).remove()},statsTemplate:{"merchant":_.template(window.Invoices.TEMPLATE["merchant.merchant"]),"merchantLoader":_.template(window.Invoices.TEMPLATE["merchant.merchantLoader"]),"merchantDialogLogo":_.template(window.Invoices.TEMPLATE["merchant.merchantDialogLogo"])},l10nHash:{"ru":JSON.parse(window.Invoices.L10N["merchant.ru"]),"ua":JSON.parse(window.Invoices.L10N["merchant.ua"])},render:function(opt){opt=opt||{};if(!this.model.get("id"))this.model.fetch({data:{filter:["s","s_set"]},error:opt.error,
success:function(model){model.set(model.get("s"));model.set(model.get("s_set"));if(typeof opt.success=="function")opt.success.call(this,model)},loader:opt.loader});else if(typeof opt.success=="function")opt.success.call(this.model,this.model);return this},renderDisplay:function(tab){var self=this;if(_.indexOf(["contacts","pay","general"],tab)<0)tab="contacts";this.render({error:function(model,err){if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},success:function(model){if(!self.helperPrimeRender){self.eventChange.call(self,
model);$("#invoicesMerchantTabs",self.el).itabs({elTabs:$("#invoicesMerchantTabs #invoicesMerchantTabsList",self.el),selectorItem:"[data-id]"});self.helperDialogLogo()}self.helperPrimeRender=true;$("#invoicesMerchantTabs",self.el).itabs("select","merchant/"+tab+"/");$('[name="is_vat_payer"]',self.el).trigger("change");$('[name="to_notify"]',self.el).trigger("change");$('[name="pref_payment_id"]',self.el).trigger("change");self.helperTab=tab},loader:function(progress){if(progress==0)self.eventAddLoader.call(self);
else if(progress==1)self.eventRemoveLoader.call(self)}});return this},helperPrimeRender:false,events:{"click #invoicesMerchantEditLogo":"eventDOMDialogLogo",'change [name="title"]':"eventDOMChange",'change [name="email"]':"eventDOMChange",'change [name="addr"]':"eventDOMChange",'change [name="card"]':"eventDOMChange",'change [name="to_sms"]':"eventDOMChange",'change [name="is_vat_payer"]':"eventDOMChangeCheckbox",'change [name="to_notify"]':"eventDOMChangeCheckbox",'change [name="pref_payment_id"]':"eventDOMChangeSelect",
'click [id^="invoicesMerchantSave"]':"eventDOMSave"},eventDOMDialogLogo:function(e){$("#invoicesMerchantDialogLogo").dialog("open")},eventDOMChange:function(e){var self=this,data={};data[$(e.target).attr("name")]=$(e.target).val();this.model.set(data,{error:function(model,err){$(e.target).ierror({wrap:true,msg:self.helperGetError.call(self,model,err)})}})},eventDOMChangeCheckbox:function(e){this.helperChangeCheckbox.call(this,e.target);this.eventDOMChange.call(this,e)},eventDOMChangeSelect:function(e){this.helperChangeSelect.call(this,
e.target);this.eventDOMChange.call(this,e)},eventDOMSave:function(e){var self=this,arg={};$('[data-id="#merchant/'+this.helperTab+'/"] [name]',this.el).each(function(){arg[$(this).attr("name")]=$(this).val()});this.model.save(arg,{error:function(model,err){if(err.attr)$('[name="'+err.attr+'"]',self.el).ierror({wrap:true,msg:self.helperGetError.call(self,model,err)});if(err.error==1||err.msg)$.ierrorDialog("add",err.msg)},loader:function(progress){if(progress==0)self.eventAddLoader.call(self);else if(progress==
1)self.eventRemoveLoader.call(self)}})},helperDialogLogo:function(){var self=this;this.el.append(this.statsTemplate["merchantDialogLogo"].call(this));$("#invoicesMerchantDialogLogo",this.el).iplaceholder().dialog({autoOpen:false,resizable:false,modal:true,draggable:false,buttons:[{text:"Ok",click:function(){var dialog=this,value=$('[name="logo_url"]',dialog).val()||null;var res=self.model.set({logo_url:value},{error:function(model,err){$('[name="logo_url"]',dialog).ierror({wrap:true,msg:self.helperGetError.call(self,
model,err)})}});if(res){if(value)$("#invoicesMerchantLogo",self.el).css("background-image","url("+value+")");$(this).dialog("close")}}},{text:"Cancel",click:function(){$(this).dialog("close")}}]})},helperChangeSelect:function(el){var value=$(el).val();$("#invoicesMerchantPayTable [data-id]").hide();$('#invoicesMerchantPayTable [data-id="'+value+'"]').show()},helperChangeCheckbox:function(el){var name=$(el).attr("name");if($(el).attr("checked")){$('#invoicesMerchantGeneralTable [data-id="'+name+'"]',
this.el).removeClass("disabled");$(el).val(1)}else if(!$(el).attr("checked")){$('#invoicesMerchantGeneralTable [data-id="'+name+'"]',this.el).addClass("disabled");$(el).val(0)}},helperGetError:function(model,err){switch(err.attr){case "card":return this.l10n("Merchant card - incorrect");case "email":return this.l10n("Merchant email - incorrect");case "title":return this.l10n("Merchant title - incorrect");case "logo_url":return this.l10n("Merchant logo_url - incorrect")}},helperTab:undefined});window.Invoices.ModelRouter=Backbone.Model.extend({defaults:{id:0,type:"",view:null}});window.Invoices.CollectionRouters=Backbone.Collection.extend({model:window.Invoices.ModelRouter,initialize:function(){}});window.Invoices.Router=Backbone.Router.extend({initialize:function(opt){this.l10nLang=opt.l10nLang||"en";this.route(/^(invoice\/).*$/i,"iteminvoice",this.iteminvoice);this.route(/^(invoice\/(view|edit|send|print)\/).*$/i,"iteminvoice",this.iteminvoice);this.route(/^(invoice\/(view|edit|send|print)\/([0-9]+)\/).*$/i,"iteminvoice",this.iteminvoice);this.route(/^(invoices\/).*$/i,"invoices",this.invoices);this.route(/^(invoices\/([a-z0-9]+)\/).*$/i,"invoices",this.invoices);this.route(/^(buyers\/).*$/i,
"buyers",this.buyers);this.route(/^(buyers\/([a-z0-9]+)\/).*$/i,"buyers",this.buyers);this.route(/^(goods\/).*$/i,"goods",this.goods);this.route(/^(goods\/([a-z0-9]+)\/).*$/i,"goods",this.goods);this.route(/^(merchant\/).*$/i,"merchant",this.merchant);this.route(/^(merchant\/(contacts|general|pay)\/).*$/i,"merchant",this.merchant);this.collection=new window.Invoices.CollectionRouters},routes:{"":"iteminvoice"},invoices:function(query,status){this.helperRenderGlobalMenu(query);this.helperHide("globalmenu");
this.helperRenderInvoices(status);this.helperShow("invoicesStatus")},buyers:function(query,group){this.helperRenderGlobalMenu(query);this.helperHide("globalmenu");group=parseInt(group);group=group>0?group:1;this.helperRenderBuyers(group);this.helperRemove("invoiceHelpBuyer");this.helperShow("buyers")},goods:function(query,group){this.helperRenderGlobalMenu(query);this.helperHide("globalmenu");group=group==undefined?1:parseInt(group);this.helperRenderGoods(group);this.helperRemove("invoiceHelpGoods");
this.helperShow("goods")},iteminvoice:function(query,mod,id){this.helperRenderGlobalMenu(query);this.helperHide("globalmenu");this.helperRenderHelpBuyer();this.helperRenderHelpGoods();this.helperRenderInvoice(id,mod);this.helperShow("invoice")},merchant:function(query,tab){this.helperRenderGlobalMenu(query);this.helperHide("globalmenu");if(!this.collection.get("merchant"))this.helperRenderMerchant();this.collection.get("merchant").get("view").renderDisplay(tab);this.helperShow("merchant")},helperRenderMerchant:function(){var el=
$("#invoicesMerchant");this.collection.add({id:"merchant",el:el,view:new window.Invoices.ViewMerchant({router:this,el:el})})},helperRenderGlobalMenu:function(query){if(!this.collection.get("globalmenu")){this.collection.add({id:"globalmenu",view:new window.Invoices.ViewGlobalMenu({router:this})});this.collection.get("globalmenu").get("view").render();this.collection.get("globalmenu").get("view").renderItem(query)}else this.collection.get("globalmenu").get("view").renderItem(query)},helperRenderBuyers:function(group){if(!this.collection.get("buyers")){var el=
$("#invoicesClients");this.collection.add({id:"buyers",el:el,view:new window.Invoices.ViewBuyersGroups({router:this,el:el})});this.collection.get("buyers").get("view").render(group);this.collection.get("buyers").get("view").renderItem(group)}else this.collection.get("buyers").get("view").renderItem(group)},helperRenderGoods:function(group){if(!this.collection.get("goods")){var el=$("#invoicesPs");this.collection.add({id:"goods",el:el,view:new window.Invoices.ViewGoodsGroups({router:this,el:el})});
this.collection.get("goods").get("view").render(group);this.collection.get("goods").get("view").renderItem(group)}else this.collection.get("goods").get("view").renderItem(group)},helperRenderInvoices:function(status){if(!this.collection.get("invoicesStatus")){var el=$("#invoicesInvoices");this.collection.add({id:"invoicesStatus",el:el,view:new window.Invoices.ViewInvoicesStatus({router:this,el:el})});this.collection.get("invoicesStatus").get("view").render();this.collection.get("invoicesStatus").get("view").renderItem(status)}else this.collection.get("invoicesStatus").get("view").renderItem(status)},
helperRenderInvoice:function(id,mod){if(!this.collection.get("invoice")){var el=$("#invoicesItemInvoice");this.collection.add({id:"invoice",el:el,view:new window.Invoices.ViewInvoice({router:this,el:el})})}var collection=this.collection.get("invoice").get("view").collection;if(collection.length>1)collection.each(function(model,index){if(model.id&&id&&id!=model.id)collection.remove(model)});this.collection.get("invoice").get("view").render(id,mod);var buyers=this.collection.get("buyers");if(buyers)buyers.get("view").collectionBuyers=
new window.Invoices.CollectionRouters;var goodss=this.collection.get("goods");if(goodss)goodss.get("view").collectionGoodss=new window.Invoices.CollectionRouters},helperRenderHelpBuyer:function(){if(!this.collection.get("invoiceHelpBuyer"))this.collection.add({id:"invoiceHelpBuyer",view:new window.Invoices.ViewItemInvoiceHelpBuyer({router:this})})},helperRenderHelpGoods:function(){if(!this.collection.get("invoiceHelpGoods"))this.collection.add({id:"invoiceHelpGoods",view:new window.Invoices.ViewItemInvoiceHelpGoods({router:this})})},
helperRemove:function(indexs){indexs=indexs instanceof Array?indexs:[indexs];for(var i=0;i<indexs.length;i++){var help=this.collection.get(indexs[i]);if(help)this.collection.remove(help)}},helperHide:function(indexs){indexs=indexs instanceof Array?indexs:[indexs];this.collection.each(function(model){if(!_.include(indexs,model.get("id")))$(model.get("el")).hide()})},helperShow:function(indexs){indexs=indexs instanceof Array?indexs:[indexs];this.collection.each(function(model){if(_.include(indexs,model.get("id")))$(model.get("el")).show()})}});
